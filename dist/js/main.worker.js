(()=>{"use strict";function t(t,e=2.2){return t.map((t=>{let r=t/255;return r=r>.04045?Math.pow((r+.055)/1.055,e):r/12.92,100*r}))}function e(t,e=2.2){return t.map((t=>{let r=t/100;return r=r>.0031308?1.055*Math.pow(r,1/e)-.055:12.92*r,~~(255*r)}))}function r(e,r=2.2){return function(t){let e=[95.047*t[0],100*t[1],108.883*t[2]];return e=e.map((t=>t>.008856?Math.pow(t,1/3):7.787*t+16/116)),[116*e[1]-16,500*(e[0]-e[1]),200*(e[1]-e[2])]}(function(e,r=2.2){const o=t(e,r);return[.4124*o[0]+.3576*o[1]+.1805*o[2],.2126*o[0]+.7152*o[1]+.0722*o[2],.0193*o[0]+.1192*o[1]+.9505*o[2]]}(e,r))}var o;!function(t){t.Indexed2Bit="2-bit (4 color) Indexed",t.Indexed4Bit="4-bit (16 color) Indexed",t.Mono="Monochrome",t.RGB="RGB",t.RGBI="4-bit (16 color) RGBI",t.Auto="Optimized (Auto)",t.Other="Other",t.Generated="AUTOGENERATED PALETTE"}(o||(o={}));const a=o;var n;!function(t){t[t.Indexed=0]="Indexed",t[t.Mono=1]="Mono",t[t.RGB=2]="RGB",t[t.Auto=3]="Auto"}(n||(n={}));const s=n,c=class{static getSize(t){switch(t.type){case s.Indexed:return t.data.length/3;case s.Mono:return t.data[0];case s.RGB:return t.data[0]*t.data[1]*t.data[2];case s.Auto:default:return 0}}static getColor(t,e){if(e<0||e>=this.getSize(t))throw new Error(`Color index ${e} out of bounds`);switch(t.type){case s.Indexed:return t.data.slice(3*e,3*e+3);case s.Mono:return t.data.slice(1,4).map((r=>{const o=r*t.data[4];return o+e*~~((r-o)/(t.data[0]-1))}));case s.RGB:{const r=e%t.data[2],o=~~(e/t.data[2])%t.data[1];return[~~(e/(t.data[2]*t.data[1])),o,r].map(((e,r)=>e*~~(255/(t.data[r]-1))))}case s.Auto:default:throw new Error("Invalid or Auto palette type")}}static getColors(t){return Array.from({length:this.getSize(t)},((e,r)=>this.getColor(t,r)))}static transform(t,e){const r=this.getColors(t).map((t=>e(t)));return{name:`${t.name} :: ${e.name}`,type:s.Indexed,group:a.Generated,data:r.reduce(((t,e)=>t.concat(e)))}}},l=(t,e)=>(t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1])+(t[2]-e[2])*(t[2]-e[2]);function d(t,e){return l(t,e)}function i(t,r){return d(e(t),e(r))}const u={};function m(t,e){const o=t[0]+(t[1]<<8)+(t[2]<<16),a=e[0]+(e[1]<<8)+(e[2]<<16);let n=u[o];n||(n=r(t),u[o]=n);let s=u[a];return s||(s=r(e),u[a]=s),l(n,s)}function f(t,e,r){let o=[],a=Number.POSITIVE_INFINITY;for(let n=0;n<c.getSize(e);n++){const s=c.getColor(e,n),l=r(t,s);l<=a&&(o=s,a=l)}return o}const h={id:"ProcBasic",name:"Basic (no dithering)",procFn:(t,e,r,o,a)=>{const n=4*t.width,s=t.width*t.height*4;for(let o=0;o<s;o+=4){const c=f(Array.from(t.data.slice(o,o+4)),e,r);for(let e=0;e<3;e++)t.data[o+e]=c[e];o%(8*n)==0&&a&&a(o,s,t)}return t},maxAllowedPaletteSize:65536,supports:{threads:!1,gamma:!1},complexity:t=>t},p=[0,48,12,60,3,51,15,63,32,16,44,28,35,19,47,31,8,56,4,52,11,59,7,55,40,24,36,20,43,27,39,23,2,50,14,62,1,49,13,61,34,18,46,30,33,17,45,29,10,58,6,54,9,57,5,53,42,26,38,22,41,25,37,21].map((t=>t/64));function g(t,e,r,o,a){return a(t,e)+r*((o<0?-o:o)+.5)}function w(t=!0){return(e,r,o,a,n)=>{const s=e.width*e.height*4,l=4*e.width,d=c.getColors(r),i={};for(let t=0;t<d.length;t++)for(let e=t;e<d.length;e++)i[t*d.length+e]=.1*o(d[t],d[e]);const u=[0,0,0];let m,f,h,w;for(let r=0;r<s;r+=4){m=Array.from(e.data.slice(r,r+4));const a=p[r%l/4%8+~~(r/l)%8*8];w={color1:[0,0,0],color2:m,ratio:.33};let c=Number.MAX_VALUE;for(let e=0;e<d.length;e++)for(let r=e;r<d.length;r++)if(f=d[e],h=d[r],t){let t=32;e!==r&&(t=((f[0]!==h[0]?19136*(m[0]-f[0])/(h[0]-f[0]):0)+(f[1]!==h[1]?37568*(m[1]-f[1])/(h[1]-f[1]):0)+(f[2]!==h[2]?7296*(m[2]-f[2])/(h[2]-f[2]):0))/((f[0]!==h[0]?299:0)+(f[1]!==h[1]?587:0)+(f[2]!==h[2]?114:0)),t<0?t=0:t>63&&(t=63),t=~~t);const a=t/64;for(let t=0;t<3;t++)u[t]=f[t]+a*(h[t]-f[t]);const n=g(m,u,i[e*d.length+r],a-.5,o);n<c&&(c=n,w.color1=f,w.color2=h,w.ratio=a)}else for(let t=0;t<64&&!(e===r&&t>0);t++){const a=t/64;for(let t=0;t<3;t++)u[t]=f[t]+a*(h[t]-f[t]);const n=g(m,u,i[e*d.length+r],a-.5,o);n<c&&(c=n,w.color1=f,w.color2=h,w.ratio=a)}for(let t=0;t<3;t++)e.data[r+t]=a<w.ratio?w.color2[t]:w.color1[t];r%(4*l)==0&&n&&n(r,s,e)}return e}}const A={id:"ProcBayerLikeFast",name:"Ordered (Bayer-like) – Fast",procFn:w(),maxAllowedPaletteSize:192,supports:{threads:!0,gamma:!1},complexity:t=>t*t/2},I={id:"ProcBayerLikeThorough",name:"Ordered (Bayer-like) – High Quality",procFn:w(!1),maxAllowedPaletteSize:24,supports:{threads:!0,gamma:!1},complexity:t=>t*t*32},y={id:"ProcFloydSteinberg",name:"Floyd–Steinberg",procFn:(r,o,a,n,s)=>{const l=r.width*r.height*4,u=4*r.width;if(n.gamma){for(let e=0;e<l;e+=4){const o=t(Array.from(r.data.slice(e,e+3)));for(let t=0;t<3;t++)r.data[e+t]=o[t];e%(4*u)==0&&s&&s(e,l,r)}o=c.transform(o,t)}for(let t=0;t<l;t+=4){const a=Array.from(r.data.slice(t,t+3)),c=f(a,o,n.gamma?i:d);for(let o=0;o<3;o++)r.data[t+o]=(n.gamma?e(c):c)[o];const m=a.map(((t,e)=>t-c[e]));for(let e=0;e<3;e++)r.data[t+4+e]+=7*m[e]/16,r.data[t+u-4+e]+=3*m[e]/16,r.data[t+u+e]+=5*m[e]/16,r.data[t+u+4+e]+=1*m[e]/16;t%(4*u)==0&&s&&s(t,l,r)}return r},maxAllowedPaletteSize:65536,supports:{threads:!1,gamma:!0},complexity:t=>t};function x(t,e=2.2,r=!1){const o=[0,0,0];for(let a=0;a<3;a++)if(r){const r=t[a]<0?-1:1;o[a]=r*Math.pow(t[a]*r/255,e)}else o[a]=Math.pow(t[a]/255,e);return o}function M(t,e=2.2,r=!1){const o=1/e;if(r){const e=t<0?-1:1;return e*Math.pow(t*e,o)*255}return 255*Math.pow(t,o)}const B=[0,48,12,60,3,51,15,63,32,16,44,28,35,19,47,31,8,56,4,52,11,59,7,55,40,24,36,20,43,27,39,23,2,50,14,62,1,49,13,61,34,18,46,30,33,17,45,29,10,58,6,54,9,57,5,53,42,26,38,22,41,25,37,21].map((t=>t/64)),P={id:"ProcWeightedColorMap",name:"Ordered (Weighted Color Map)",procFn:(t,e,r,o,a)=>{const n=t.width*t.height*4,s=4*t.width,l=[];let d,i,u,m;const f=[0,0,0],h=c.getColors(e).map((t=>299*t[0]+587*t[1]+114*t[2])),p=c.getColors(o.gamma?c.transform(e,x):e);for(let g=0;g<n;g+=4){d=Array.from(t.data.slice(g,g+4));const w=g%s/4,A=~~(g/s);for(l.splice(0),u=[0,0,0];l.length<16;){let t=0,e=1,a=Number.MAX_VALUE;const n=l.length||1;for(let s=0;s<p.length;s++){i=[...p[s]],m=[...u];for(let c=1;c<=n;c*=2){const n=l.length+c;for(let t=0;t<3;t++)m[t]=u[t]+i[t]*c,f[t]=m[t]/n,o.gamma&&(f[t]=M(f[t]));const h=r(f,d);h<a&&(e=c,t=s,a=h)}}for(let r=0;r<e;r++)l.push(t);for(let r=0;r<3;r++)u[r]+=p[t][r]*e}l.sort(((t,e)=>h[t]-h[e]));const I=~~(B[w%8+A%8*8]*l.length);for(let r=0;r<3;r++)t.data[g+r]=c.getColor(e,l[I])[r];g%(4*s)==0&&a&&a(g,n,t)}return t},maxAllowedPaletteSize:256,supports:{threads:!0,gamma:!0},complexity:t=>384*t},E=self;var C;!function(t){t[t.Progress=0]="Progress",t[t.Done=1]="Done",t[t.Error=2]="Error"}(C||(C={}));const F=(t,e,r)=>{E.postMessage({msg:C.Progress,params:{current:t,total:e,partial:r}})};E.addEventListener("message",(t=>{const e=t.data,r=(t=>{switch(t){case h.id:return h;case y.id:return y;case A.id:return A;case I.id:return I;case P.id:return P;default:return null}})(e.procId);if(!r)return E.postMessage({msg:C.Error,params:{error:`WorkerInit failed: process ${e.procId} not found`}}),void self.close();const o=(t=>{switch(t){case"cdLab":return m;case"cdRGB":default:return d}})(e.distFnId);r.procFn(e.dataIn,e.palette,o,e.features,F),E.postMessage({msg:C.Done,params:{result:e.dataIn}}),self.close()}))})();