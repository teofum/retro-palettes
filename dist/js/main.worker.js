(()=>{"use strict";function t(t){return function(t){let e=[95.047*t[0],100*t[1],108.883*t[2]];return e=e.map((t=>t>.008856?Math.pow(t,1/3):7.787*t+16/116)),[116*e[1]-16,500*(e[0]-e[1]),200*(e[1]-e[2])]}(function(t){const e=t.map((t=>{let e=t/255;return e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,100*e}));return[.4124*e[0]+.3576*e[1]+.1805*e[2],.2126*e[0]+.7152*e[1]+.0722*e[2],.0193*e[0]+.1192*e[1]+.9505*e[2]]}(t))}var e,r;(r=e||(e={})).P2BitIndexed="2-bit (4 color) Indexed",r.P4BitRGBI="4-bit (16 color) RGBI",r.P4BitIndexed="4-bit (16 color) Indexed",r.PMono="Monochrome",r.PRGB="RGB",r.PAuto="Optimized (Auto)",r.POther="Other";const o=e,s=(t,e)=>(t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1])+(t[2]-e[2])*(t[2]-e[2]);function l(t,e){return s(t,e)}const a={};function n(e,r){const o=e[0]+(e[1]<<8)+(e[2]<<16),l=r[0]+(r[1]<<8)+(r[2]<<16);let n=a[o];n||(n=t(e),a[o]=n);let i=a[l];return i||(i=t(r),a[l]=i),s(n,i)}class i{constructor(t){var e;this.generated=!1,this.levels=t.levels,this.tree=(e=t.levels,Array.from({length:Math.pow(8,e)},(()=>new class{constructor(){this.colors=[],this.pixels=0}get pixelCount(){return this.pixels}get avgColor(){const t=[0,0,0];for(let e=0;e<this.colors.length;e++)for(let r=0;r<3;r++)t[r]+=this.colors[e][r];return t.map((t=>t/this.colors.length))}addColor(t){this.colors.includes(t)||this.colors.push(t),this.pixels++}}))),this.ctes=[],this.reservedLevel=t.reservedLevel,this.nColors=t.numColors,this.k=t.inclThresholdCoeff||1}addColor(t){if(this.generated)throw new Error("Attempting to modify a generated palette");const e=this.index(t);return this.tree[e].addColor(t),e}getPalette(){this.generated||this.generate();const t=[];return this.ctes.forEach((e=>{const r=e.index,o=[0,0,0];for(let t=0;t<e.level;t++)for(let s=2;s>=0;s--){const l=3*(e.level-1-t)+s,a=1<<3*e.level-1>>3*t+(2-s);o[2-s]=o[2-s]<<1|(r&a)>>l}for(let t=e.level;t<8;t++)for(let r=0;r<3;r++)o[r]=o[r]<<1|(t===e.level?1:0);t.push(o)})),console.log(`Built palette with ${t.length} colors`),t}index(t){let e=0;for(let r=0;r<this.levels;r++){const o=7-r;let s=0;for(let e=0;e<3;e++){const l=128>>r;s=s<<1|(t[e]&l)>>o}e=e<<3|s}return e}getNode(t,e){if(e===this.levels)return this.tree[t];const r=[];for(let o=0;o<8;o++)this.isCTE(8*t+o,e+1)||r.push(this.getNode(8*t+o,e+1));return r.filter((t=>t.pixelCount>0)).reduce(((t,e)=>({pixelCount:t.pixelCount+e.pixelCount})),{pixelCount:0})}isCTE(t,e){return this.ctes.some((r=>r.index===t&&r.level===e))}markCTE(t,e,r){this.ctes.push({index:t,level:e,node:r})}testNode(t,e,r,o){const s=t-e-this.ctes.length,l=(r-this.ctes.map((t=>t.node.pixelCount)).reduce(((t,e)=>t+e),0))/s*this.k;return o.pixelCount>l}get nonReservedCTEs(){return this.ctes.filter((t=>t.level!==this.reservedLevel)).length}generate(){if(this.generated)throw new Error("This palette has already been generated");this.generated=!0;const t=this.reservedLevel<0?0:Math.pow(8,this.reservedLevel),e=this.getNode(0,0).pixelCount;let r,o=0,s=0;for(;this.nColors-t-this.nonReservedCTEs>0;){for(r=this.levels;r>this.reservedLevel&&r>0;){const o=Math.pow(8,r);for(let s=0;s<o;s++){const o=this.getNode(s,r);if(!this.isCTE(s,r)&&this.testNode(this.nColors,t,e,o)&&this.markCTE(s,r,o),s%8==7){let t=0;for(let e=s-7;e<=s;e++)this.isCTE(e,r)&&t++;if(t>0&&t<8){const t=s>>3;this.isCTE(t,r-1)||this.markCTE(t,r-1,this.getNode(t,r-1))}}if(this.nColors-t-this.nonReservedCTEs<=0)break}if(this.nColors-t-this.nonReservedCTEs<=0)break;r--}if(this.ctes.length===o&&(this.k=this.k/2,s++,s>=5))break;o=this.ctes.length}if(this.reservedLevel>=0){r=this.reservedLevel;const t=Math.pow(8,r);for(let e=0;e<t;e++){const t=this.getNode(e,r);this.isCTE(e,r)||this.markCTE(e,r,t)}}}}const d=[];function h(t,e,r){switch(e.type){case o.PRGB:return function(t,e){const r=e.data[0].map((t=>Math.pow(2,t))),o=[...t];for(let e=0;e<3;e++){const s=~~(t[e]/(256/r[e]));o[e]=s*(255/(r[e]-1))}return o}(t,e);default:return function(t,e,r){let o=[],s=Number.POSITIVE_INFINITY;return e.data.forEach((e=>{const l=r(t,e);l<=s&&(o=e,s=l)})),o}(t,e,r)}}const c={id:"ProcBasic",name:"Basic (no dithering)",procFn:(t,e,r,o)=>{const s=4*t.width,l=t.width*t.height*4;for(let a=0;a<l;a+=4){const n=h(Array.from(t.data.slice(a,a+4)),e,r);for(let e=0;e<3;e++)t.data[a+e]=n[e];a%(8*s)==0&&o&&o(a,l,t)}return t},maxAllowedPaletteSize:65536,supportsMultipleThreads:!1,complexity:t=>t},u=[0,48,12,60,3,51,15,63,32,16,44,28,35,19,47,31,8,56,4,52,11,59,7,55,40,24,36,20,43,27,39,23,2,50,14,62,1,49,13,61,34,18,46,30,33,17,45,29,10,58,6,54,9,57,5,53,42,26,38,22,41,25,37,21].map((t=>t/64));function p(t,e,r,o,s){return s(t,e)+r*((o<0?-o:o)+.5)}function f(t=!0){return(e,r,s,l)=>{r.type===o.PRGB&&(r=(t=>{if(t.type!==o.PRGB)throw new Error("Not an RGB palette");const e=t.data[0].map((t=>Math.pow(2,t))),r={name:"EXPANDED_RGB",type:o.POther,useAlpha:!1,data:[]};for(let t=0;t<e[0];t++)for(let o=0;o<e[1];o++)for(let s=0;s<e[2];s++){const l=[t,o,s],a=[t,o,s];for(let t=0;t<3;t++)a[t]=l[t]*(255/(e[t]-1));r.data.push(a)}return r})(r));const a=e.width*e.height*4,n=4*e.width,i={};for(let t=0;t<r.data.length;t++)for(let e=t;e<r.data.length;e++)i[t*r.data.length+e]=.1*s(r.data[t],r.data[e]);const d=[0,0,0];let h,c,f,g;for(let o=0;o<a;o+=4){h=Array.from(e.data.slice(o,o+4));const m=u[o%n/4%8+~~(o/n)%8*8];g={color1:[0,0,0],color2:h,ratio:.33};let v=Number.MAX_VALUE;for(let e=0;e<r.data.length;e++)for(let o=e;o<r.data.length;o++)if(c=r.data[e],f=r.data[o],t){let t=32;e!==o&&(t=((c[0]!==f[0]?19136*(h[0]-c[0])/(f[0]-c[0]):0)+(c[1]!==f[1]?37568*(h[1]-c[1])/(f[1]-c[1]):0)+(c[2]!==f[2]?7296*(h[2]-c[2])/(f[2]-c[2]):0))/((c[0]!==f[0]?299:0)+(c[1]!==f[1]?587:0)+(c[2]!==f[2]?114:0)),t<0?t=0:t>63&&(t=63),t=~~t);const l=t/64;for(let t=0;t<3;t++)d[t]=c[t]+l*(f[t]-c[t]);const a=p(h,d,i[e*r.data.length+o],l-.5,s);a<v&&(v=a,g.color1=c,g.color2=f,g.ratio=l)}else for(let t=0;t<64&&!(e===o&&t>0);t++){const l=t/64;for(let t=0;t<3;t++)d[t]=c[t]+l*(f[t]-c[t]);const a=p(h,d,i[e*r.data.length+o],l-.5,s);a<v&&(v=a,g.color1=c,g.color2=f,g.ratio=l)}for(let t=0;t<3;t++)e.data[o+t]=m<g.ratio?g.color2[t]:g.color1[t];o%(4*n)==0&&l&&l(o,a,e)}return e}}const g={id:"ProcBayerLikeFast",name:"Ordered (Bayer-like) – Fast",procFn:f(),maxAllowedPaletteSize:192,supportsMultipleThreads:!0,complexity:t=>t*t/2},m={id:"ProcBayerLikeThorough",name:"Ordered (Bayer-like) – High Quality",procFn:f(!1),maxAllowedPaletteSize:24,supportsMultipleThreads:!0,complexity:t=>t*t*32},v={id:"ProcFloydSteinberg",name:"Floyd–Steinberg",procFn:(t,e,r,o)=>{const s=t.width*t.height*4,l=4*t.width;for(let a=0;a<s;a+=4){const n=Array.from(t.data.slice(a,a+4)),i=h(n,e,r);for(let e=0;e<3;e++)t.data[a+e]=i[e];const d=n.map(((t,e)=>t-i[e]));for(let e=0;e<3;e++)t.data[a+4+e]+=7*d[e]/16,t.data[a+l-4+e]+=3*d[e]/16,t.data[a+l+e]+=5*d[e]/16,t.data[a+l+4+e]+=1*d[e]/16;a%(4*l)==0&&o&&o(a,s,t)}return t},maxAllowedPaletteSize:65536,supportsMultipleThreads:!1,complexity:t=>t},C=[0,48,12,60,3,51,15,63,32,16,44,28,35,19,47,31,8,56,4,52,11,59,7,55,40,24,36,20,43,27,39,23,2,50,14,62,1,49,13,61,34,18,46,30,33,17,45,29,10,58,6,54,9,57,5,53,42,26,38,22,41,25,37,21].map((t=>t/64)),w={id:"ProcWeightedColorMap",name:"Ordered (Weighted Color Map)",procFn:(t,e,r,o)=>{const s=t.width*t.height*4,l=4*t.width,a=[];let n,i,d,h;const c=e.data.map((t=>299*t[0]+587*t[0]+114*t[0])),u=e.data.map((t=>t.map((t=>Math.pow(t/255,2.2)))));for(let p=0;p<s;p+=4){n=Array.from(t.data.slice(p,p+4));const f=p%l/4,g=~~(p/l);for(a.splice(0),d=[0,0,0];a.length<16;){let t=0,o=1,s=Number.MAX_VALUE;const l=a.length||1;for(let c=0;c<e.data.length;c++){i=u[c];for(let e=1;e<=l;e*=2){h=d.map(((t,r)=>255*Math.pow((t+i[r]*e)/(a.length+e),.45454545454545453)));const l=r(h,n);l<s&&(o=e,t=c,s=l)}}for(let e=0;e<o;e++)a.push(t);d=d.map(((e,r)=>e+u[t][r]*o))}a.sort(((t,e)=>c[t]-c[e]));const m=~~(C[f%8+g%8*8]*a.length);for(let r=0;r<3;r++)t.data[p+r]=e.data[a[m]][r];p%(4*l)==0&&o&&o(p,s,t)}return t},maxAllowedPaletteSize:256,supportsMultipleThreads:!0,complexity:t=>384*t},x=self;var E;!function(t){t[t.Progress=0]="Progress",t[t.Done=1]="Done",t[t.Error=2]="Error"}(E||(E={}));const P=(t,e,r)=>{x.postMessage({msg:E.Progress,params:{current:t,total:e,partial:r}})};x.addEventListener("message",(t=>{const e=t.data,r=e.palette.type===o.PAuto?function(t,e){const r=`AUTO_${t.data[0][0]}_${t.data[1][2]}`,s=d.find((t=>t.key===r));if(s)return s.palette;{const s=function(t,e){const r=new i(t),s=e.width*e.height*4;for(let t=0;t<s;t+=4){const o=~~(t/4/e.width);if(~~(t/4%e.width)%2==0&&o%2==0){const o=Array.from(e.data.slice(t,t+4));r.addColor(o)}}const l=r.getPalette();return{name:"__GENERATED__",type:o.POther,useAlpha:!1,data:l}}({numColors:t.data[0][0],reservedLevel:t.data[0][1],levels:t.data[0][2],inclThresholdCoeff:t.data[1][0]},e);return d.push({key:r,palette:s}),s}}(e.palette,e.dataIn):e.palette,s=(t=>{switch(t){case c.id:return c;case v.id:return v;case g.id:return g;case m.id:return m;case w.id:return w;default:return null}})(e.procId);if(s){const t=(t=>{switch(t){case"cdLab":return n;case"cdRGB":default:return l}})(e.distFnId);s.procFn(e.dataIn,r,t,P),x.postMessage({msg:E.Done,params:{result:e.dataIn}}),self.close()}else x.postMessage({msg:E.Error,params:{error:"bad procId"}}),self.close()}))})();