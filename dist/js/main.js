(()=>{"use strict";var e;!function(e){e.P2BitIndexed="2-bit (4 color) Indexed",e.P4BitRGBI="4-bit (16 color) RGBI",e.P4BitIndexed="4-bit (16 color) Indexed",e.PMono="Monochrome",e.PRGB="RGB",e.PAuto="Other",e.POther="Other"}(e||(e={}));const t=e,n={name:"CGA Mode 4 Palette 0 (low)",type:t.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[0,170,0],[170,0,0],[170,85,0]]},o={name:"CGA Mode 4 Palette 0 (high)",type:t.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[85,255,85],[255,85,85],[255,255,85]]},a={name:"CGA Mode 4 Palette 1 (low)",type:t.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[0,170,170],[170,0,170],[170,170,170]]},r={name:"CGA Mode 4 Palette 1 (high)",type:t.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[85,255,255],[255,85,255],[255,255,255]]},s={name:"CGA Mode 5 (low)",type:t.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[0,170,170],[170,0,0],[170,170,170]]},l={name:"CGA Mode 5 (high)",type:t.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[85,255,255],[255,85,85],[255,255,255]]},i={name:"CGA 4-bit RGBI (IBM)",type:t.P4BitRGBI,useAlpha:!1,data:[[0,0,0],[0,0,170],[0,170,0],[0,170,170],[170,0,0],[170,0,170],[170,85,0],[170,170,170],[85,85,85],[85,85,255],[85,255,85],[85,255,255],[255,85,85],[255,85,255],[255,255,85],[255,255,255]]},d={name:"Commodore 64",type:t.P4BitIndexed,useAlpha:!1,data:[[0,0,0],[98,98,82],[137,137,137],[173,173,173],[255,255,255],[159,78,68],[203,126,117],[109,84,18],[161,104,60],[201,212,135],[154,226,155],[92,171,94],[106,191,198],[136,126,203],[80,69,155],[160,87,163]]},c={name:"Windows 4-bit RGBI",type:t.P4BitRGBI,useAlpha:!1,data:[[0,0,0],[0,0,128],[0,128,0],[0,128,128],[128,0,0],[128,0,128],[128,128,0],[192,192,192],[128,128,128],[0,0,255],[0,255,0],[0,255,255],[255,0,0],[255,0,255],[255,255,0],[255,255,255]]},h={name:"Windows 20-color Extended RGBI",type:t.P4BitIndexed,useAlpha:!1,data:[[0,0,0],[0,0,128],[0,128,0],[0,128,128],[128,0,0],[128,0,128],[128,128,0],[192,192,192],[192,220,192],[166,202,240],[255,251,240],[160,160,164],[128,128,128],[0,0,255],[0,255,0],[0,255,255],[255,0,0],[255,0,255],[255,255,0],[255,255,255]]},u={name:"ZX Spectrum 4-bit RGBI",type:t.P4BitRGBI,useAlpha:!1,data:[[0,0,0],[0,0,215],[0,215,0],[0,215,215],[215,0,0],[215,0,215],[215,215,0],[215,215,215],[0,0,255],[0,255,0],[0,255,255],[255,0,0],[255,0,255],[255,255,0],[255,255,255]]},p={name:"Game Boy Green (2-bit MC)",type:t.PMono,useAlpha:!1,data:[[15,56,15],[48,98,48],[139,172,15],[155,188,15]]},f={name:"Game Boy White (2-bit MC)",type:t.PMono,useAlpha:!1,data:[[0,0,0],[85,85,85],[170,170,170],[255,255,255]]},m={name:"8-color RGB (3-bit, 1bpc)",type:t.PRGB,useAlpha:!1,data:[[1,1,1]]},g={name:"64-color RGB (6-bit, 2bpc)",type:t.PRGB,useAlpha:!1,data:[[2,2,2]]},v={name:"256-color RGB (8-bit, 3-3-2)",type:t.PRGB,useAlpha:!1,data:[[3,3,2]]},C=(e,t)=>(e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])+(e[2]-t[2])*(e[2]-t[2]),A={name:"Macintosh II (1987)",type:t.P4BitIndexed,useAlpha:!1,data:[[255,255,255],[255,255,0],[255,102,0],[221,0,0],[255,0,153],[51,0,153],[0,0,204],[0,153,255],[0,170,0],[0,102,0],[102,51,0],[153,102,51],[187,187,187],[136,136,136],[68,68,68],[0,0,0]]},B={name:"Auto 16-color (4-bit indexed)",type:t.PAuto,useAlpha:!1,data:[[16,-1,4],[1,0,0]]},y={name:"Auto 64-color (6-bit indexed)",type:t.PAuto,useAlpha:!1,data:[[64,1,5],[1,0,0]]},E={name:"Auto 256-color (8-bit indexed)",type:t.PAuto,useAlpha:!1,data:[[256,2,5],[1,0,0]]},w={name:"Black/White (1-bit MC)",type:t.PMono,useAlpha:!1,data:[[0,0,0],[255,255,255]]},P={name:"Black/Green (1-bit MC)",type:t.PMono,useAlpha:!1,data:[[0,0,0],[0,255,0]]},I={name:"Black/Amber (1-bit MC)",type:t.PMono,useAlpha:!1,data:[[0,0,0],[255,200,15]]};class x{constructor(e){var t;this.generated=!1,this.levels=e.levels,this.tree=(t=e.levels,Array.from({length:Math.pow(8,t)},(()=>new class{constructor(){this.colors=[],this.pixels=0}get pixelCount(){return this.pixels}get avgColor(){const e=[0,0,0];for(let t=0;t<this.colors.length;t++)for(let n=0;n<3;n++)e[n]+=this.colors[t][n];return e.map((e=>e/this.colors.length))}addColor(e){this.colors.includes(e)||this.colors.push(e),this.pixels++}}))),this.ctes=[],this.reservedLevel=e.reservedLevel,this.nColors=e.numColors,this.k=e.inclThresholdCoeff||1}addColor(e){if(this.generated)throw new Error("Attempting to modify a generated palette");const t=this.index(e);return this.tree[t].addColor(e),t}getPalette(){this.generated||this.generate();const e=[];return this.ctes.forEach((t=>{const n=t.index,o=[0,0,0];for(let e=0;e<t.level;e++)for(let a=2;a>=0;a--){const r=3*(t.level-1-e)+a,s=1<<3*t.level-1>>3*e+(2-a);o[2-a]=o[2-a]<<1|(n&s)>>r}for(let e=t.level;e<8;e++)for(let n=0;n<3;n++)o[n]=o[n]<<1|(e===t.level?1:0);e.push(o)})),console.log(`Built palette with ${e.length} colors`),e}index(e){let t=0;for(let n=0;n<this.levels;n++){const o=7-n;let a=0;for(let t=0;t<3;t++){const r=128>>n;a=a<<1|(e[t]&r)>>o}t=t<<3|a}return t}getNode(e,t){if(t===this.levels)return this.tree[e];const n=[];for(let o=0;o<8;o++)this.isCTE(8*e+o,t+1)||n.push(this.getNode(8*e+o,t+1));return n.filter((e=>e.pixelCount>0)).reduce(((e,t)=>({pixelCount:e.pixelCount+t.pixelCount})),{pixelCount:0})}isCTE(e,t){return this.ctes.some((n=>n.index===e&&n.level===t))}markCTE(e,t,n){this.ctes.push({index:e,level:t,node:n})}testNode(e,t,n,o){const a=e-t-this.ctes.length,r=(n-this.ctes.map((e=>e.node.pixelCount)).reduce(((e,t)=>e+t),0))/a*this.k;return o.pixelCount>r}get nonReservedCTEs(){return this.ctes.filter((e=>e.level!==this.reservedLevel)).length}generate(){if(this.generated)throw new Error("This palette has already been generated");this.generated=!0;const e=this.reservedLevel<0?0:Math.pow(8,this.reservedLevel),t=this.getNode(0,0).pixelCount;let n,o=0,a=0;for(;this.nColors-e-this.nonReservedCTEs>0;){for(n=this.levels;n>this.reservedLevel&&n>0;){const o=Math.pow(8,n);for(let a=0;a<o;a++){const o=this.getNode(a,n);if(!this.isCTE(a,n)&&this.testNode(this.nColors,e,t,o)&&this.markCTE(a,n,o),a%8==7){let e=0;for(let t=a-7;t<=a;t++)this.isCTE(t,n)&&e++;if(e>0&&e<8){const e=a>>3;this.isCTE(e,n-1)||this.markCTE(e,n-1,this.getNode(e,n-1))}}if(this.nColors-e-this.nonReservedCTEs<=0){console.warn(`Ran out of colors! At node ${a}, level ${n}`);break}}if(this.nColors-e-this.nonReservedCTEs<=0){console.warn(`Ran out of colors! At level ${n}`);break}n--}if(console.log(`${this.ctes.length} CTEs, ${this.ctes.length-this.nonReservedCTEs} reserved`),this.ctes.length===o&&(this.k=this.k/2,a++,a>=5))break;o=this.ctes.length}if(this.reservedLevel>=0){n=this.reservedLevel;const e=Math.pow(8,n);for(let t=0;t<e;t++){const e=this.getNode(t,n);this.isCTE(t,n)||this.markCTE(t,n,e)}}}}const b=[];function G(e,n,o){switch(n.type){case t.PRGB:return function(e,t){const n=t.data[0].map((e=>Math.pow(2,e))),o=[...e];for(let t=0;t<3;t++){const a=~~(e[t]/(256/n[t]));o[t]=a*(255/(n[t]-1))}return o}(e,n);default:return function(e,t,n){let o=[],a=Number.POSITIVE_INFINITY;return t.data.forEach((t=>{const r=n(e,t);r<=a&&(o=t,a=r)})),o}(e,n,o)}}const R={name:"Basic (no dithering)",function:(e,t,n)=>{const o=e.width*e.height*4;for(let a=0;a<o;a+=4){const o=G(Array.from(e.data.slice(a,a+4)),t,n);for(let t=0;t<3;t++)e.data[a+t]=o[t]}return e}},M={name:"Floyd–Steinberg",function:(e,t,n)=>{const o=e.width*e.height*4,a=4*e.width;for(let r=0;r<o;r+=4){const o=Array.from(e.data.slice(r,r+4)),s=G(o,t,n);for(let t=0;t<3;t++)e.data[r+t]=s[t];const l=o.map(((e,t)=>e-s[t]));for(let t=0;t<3;t++)e.data[r+4+t]+=7*l[t]/16,e.data[r+a-4+t]+=3*l[t]/16,e.data[r+a+t]+=5*l[t]/16,e.data[r+a+4+t]+=1*l[t]/16}return e}};function T(e){return function(e){let t=[95.047*e[0],100*e[1],108.883*e[2]];return t=t.map((e=>e>.008856?Math.pow(e,1/3):7.787*e+16/116)),[116*t[1]-16,500*(t[0]-t[1]),200*(t[1]-t[2])]}(function(e){const t=e.map((e=>{let t=e/255;return t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,100*t}));return[.4124*t[0]+.3576*t[1]+.1805*t[2],.2126*t[0]+.7152*t[1]+.0722*t[2],.0193*t[0]+.1192*t[1]+.9505*t[2]]}(e))}function L(e,t){return C(e,t)}const k={};function N(e,t){const n=e[0]+(e[1]<<8)+(e[2]<<16),o=t[0]+(t[1]<<8)+(t[2]<<16);let a=k[n];a||(a=T(e),k[n]=a);let r=k[o];return r||(r=T(t),k[o]=r),C(a,r)}const O=[0,48,12,60,3,51,15,63,32,16,44,28,35,19,47,31,8,56,4,52,11,59,7,55,40,24,36,20,43,27,39,23,2,50,14,62,1,49,13,61,34,18,46,30,33,17,45,29,10,58,6,54,9,57,5,53,42,26,38,22,41,25,37,21].map((e=>e/64));function _(e,t,n,o,a){return a(e,t)+n*((o<0?-o:o)+.5)}function $(e=!0){return(n,o,a)=>{o.type===t.PRGB&&(o=(e=>{if(e.type!==t.PRGB)throw new Error("Not an RGB palette");const n=e.data[0].map((e=>Math.pow(2,e))),o={name:"EXPANDED_RGB",type:t.POther,useAlpha:!1,data:[]};for(let e=0;e<n[0];e++)for(let t=0;t<n[1];t++)for(let a=0;a<n[2];a++){const r=[e,t,a],s=[e,t,a];for(let e=0;e<3;e++)s[e]=r[e]*(255/(n[e]-1));o.data.push(s)}return o})(o));const r=n.width*n.height*4,s=4*n.width,l=[],i={};for(let e=0;e<o.data.length;e++)for(let t=e;t<o.data.length;t++)i[e*o.data.length+t]=.1*a(o.data[e],o.data[t]);const d=[0,0,0];let c,h,u,p;for(let t=0;t<r;t+=4){c=Array.from(n.data.slice(t,t+4));const r=O[t%s/4%8+~~(t/s)%8*8];p={color1:[0,0,0],color2:c,ratio:.33};let f=Number.MAX_VALUE;for(let t=0;t<o.data.length;t++)for(let n=t;n<o.data.length;n++)if(h=o.data[t],u=o.data[n],e){let e=32;t!==n&&(e=((h[0]!==u[0]?19136*(c[0]-h[0])/(u[0]-h[0]):0)+(h[1]!==u[1]?37568*(c[1]-h[1])/(u[1]-h[1]):0)+(h[2]!==u[2]?7296*(c[2]-h[2])/(u[2]-h[2]):0))/((h[0]!==u[0]?299:0)+(h[1]!==u[1]?587:0)+(h[2]!==u[2]?114:0)),e<0?e=0:e>63&&(e=63),e=~~e);const r=e/64;for(let e=0;e<3;e++)d[e]=h[e]+r*(u[e]-h[e]);const s=_(c,d,i[t*o.data.length+n],r-.5,a);s<f&&(f=s,p.color1=h,p.color2=u,p.ratio=r)}else for(let e=0;e<64&&!(t===n&&e>0);e++){const r=e/64;for(let e=0;e<3;e++)d[e]=h[e]+r*(u[e]-h[e]);const s=_(c,d,i[t*o.data.length+n],r-.5,a);s<f&&(f=s,p.color1=h,p.color2=u,p.ratio=r)}for(let e=0;e<3;e++)n.data[t+e]=r<p.ratio?p.color2[e]:p.color1[e];l.push(p)}return n}}const U={name:"Ordered (Bayer-like) – Fast",function:$()},S={name:"Ordered (Bayer-like) – Precise (!SLOW!)",function:$(!1)},D=document.getElementById("canvasOriginal"),W=D.getContext("2d"),F=document.getElementById("canvasOutput"),X=[n,o,a,r,s,l,d,A,c,h,i,u,w,I,P,p,f,m,g,v,B,y,E];let V=c;const j=document.getElementById("paletteSelect");X.forEach((e=>{const t=document.createElement("option");let n;t.setAttribute("value",e.name),t.text=e.name;const o=j.getElementsByTagName("optgroup");for(let t=0;t<o.length;t++)o[t].label===e.type&&(n=o[t]);n||(n=document.createElement("optgroup"),n.label=e.type,j.appendChild(n)),n.appendChild(t)})),j.value=V.name;const z=[R,M,U,S];let Y=R;const Z=document.getElementById("processSelect");z.forEach((e=>{const t=document.createElement("option");t.setAttribute("value",e.name),t.text=e.name,Z.appendChild(t)}));const q=document.getElementById("useLab");q.addEventListener("change",(function(){J()})),j.addEventListener("change",(function(e){V=X.find((t=>t.name===e.target.value))||V,J()})),Z.addEventListener("change",(function(e){Y=z.find((t=>t.name===e.target.value))||Y,J()}));const H=document.getElementById("resizeInput");function J(){!function(e,n,o,a,r){n.width=e.width,n.height=e.height;const s=e.getContext("2d");if(!s)throw new Error("Unable to get input context");const l=n.getContext("2d");if(!l)throw new Error("Unable to get output context");const i=s.getImageData(0,0,e.width,e.height);if(!i)throw new Error("Unable to get image data from context");o.type===t.PAuto&&(o=function(e,n){const o=`AUTO_${e.data[0][0]}_${e.data[1][2]}`,a=b.find((e=>e.key===o));if(a)return a.palette;{const a=function(e,n){const o=new x(e),a=n.width*n.height*4;for(let e=0;e<a;e+=4){const t=~~(e/4/n.width);if(~~(e/4%n.width)%2==0&&t%2==0){const t=Array.from(n.data.slice(e,e+4));o.addColor(t)}}const r=o.getPalette();return{name:"__GENERATED__",type:t.POther,useAlpha:!1,data:r}}({numColors:e.data[0][0],reservedLevel:e.data[0][1],levels:e.data[0][2],inclThresholdCoeff:e.data[1][0]},n);return b.push({key:o,palette:a}),a}}(o,i)),a.function(i,o,r),null==l||l.putImageData(i,0,0)}(D,F,V,Y,q.checked?N:L)}document.getElementById("fileInput").addEventListener("change",(function(e){var t;(t=e,new Promise(((e,n)=>{const o=t.target;if(null==o?void 0:o.files){const t=o.files[0],n=new Image;n.onload=()=>e(n),n.src=URL.createObjectURL(t)}else n()}))).then((e=>function(e){let t=e.width,n=e.height;const o=parseInt(H.value,10);t>=n&&t>o&&(n=o*(n/t),t=o),n>t&&n>o&&(t=o*(t/n),n=o),D.width=t,D.height=n,null==W||W.drawImage(e,0,0,t,n),b.splice(0),J()}(e)))})),document.getElementById("toggleOriginal").addEventListener("click",(function(){F.classList.contains("clip")?F.classList.remove("clip"):F.classList.add("clip")}))})();