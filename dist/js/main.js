(()=>{"use strict";var e,t,o={};o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{var e;o.g.importScripts&&(e=o.g.location+"");var t=o.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");n.length&&(e=n[n.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),o.p=e})(),(t=e||(e={})).P2BitIndexed="2-bit (4 color) Indexed",t.P4BitRGBI="4-bit (16 color) RGBI",t.P4BitIndexed="4-bit (16 color) Indexed",t.PMono="Monochrome",t.PRGB="RGB",t.PAuto="Optimized (Auto)",t.POther="Other";const n=e,a={name:"CGA Mode 4 Palette 0 (low)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[0,170,0],[170,0,0],[170,85,0]]},r={name:"CGA Mode 4 Palette 0 (high)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[85,255,85],[255,85,85],[255,255,85]]},s={name:"CGA Mode 4 Palette 1 (low)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[0,170,170],[170,0,170],[170,170,170]]},i={name:"CGA Mode 4 Palette 1 (high)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[85,255,255],[255,85,255],[255,255,255]]},l={name:"CGA Mode 5 (low)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[0,170,170],[170,0,0],[170,170,170]]},d={name:"CGA Mode 5 (high)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[85,255,255],[255,85,85],[255,255,255]]},c={name:"CGA 4-bit RGBI (IBM)",type:n.P4BitRGBI,useAlpha:!1,data:[[0,0,0],[0,0,170],[0,170,0],[0,170,170],[170,0,0],[170,0,170],[170,85,0],[170,170,170],[85,85,85],[85,85,255],[85,255,85],[85,255,255],[255,85,85],[255,85,255],[255,255,85],[255,255,255]]},h={name:"Commodore 64",type:n.P4BitIndexed,useAlpha:!1,data:[[0,0,0],[98,98,82],[137,137,137],[173,173,173],[255,255,255],[159,78,68],[203,126,117],[109,84,18],[161,104,60],[201,212,135],[154,226,155],[92,171,94],[106,191,198],[136,126,203],[80,69,155],[160,87,163]]},u={name:"Windows 4-bit RGBI",type:n.P4BitRGBI,useAlpha:!1,data:[[0,0,0],[0,0,128],[0,128,0],[0,128,128],[128,0,0],[128,0,128],[128,128,0],[192,192,192],[128,128,128],[0,0,255],[0,255,0],[0,255,255],[255,0,0],[255,0,255],[255,255,0],[255,255,255]]},p={name:"Windows 20-color Extended RGBI",type:n.P4BitIndexed,useAlpha:!1,data:[[0,0,0],[0,0,128],[0,128,0],[0,128,128],[128,0,0],[128,0,128],[128,128,0],[192,192,192],[192,220,192],[166,202,240],[255,251,240],[160,160,164],[128,128,128],[0,0,255],[0,255,0],[0,255,255],[255,0,0],[255,0,255],[255,255,0],[255,255,255]]},m={name:"ZX Spectrum 4-bit RGBI",type:n.P4BitRGBI,useAlpha:!1,data:[[0,0,0],[0,0,215],[0,215,0],[0,215,215],[215,0,0],[215,0,215],[215,215,0],[215,215,215],[0,0,255],[0,255,0],[0,255,255],[255,0,0],[255,0,255],[255,255,0],[255,255,255]]},g={name:"Game Boy Green (2-bit MC)",type:n.PMono,useAlpha:!1,data:[[15,56,15],[48,98,48],[139,172,15],[155,188,15]]},f={name:"Game Boy White (2-bit MC)",type:n.PMono,useAlpha:!1,data:[[0,0,0],[85,85,85],[170,170,170],[255,255,255]]},y={name:"8-color RGB (3-bit, 1bpc)",type:n.PRGB,useAlpha:!1,data:[[1,1,1]]},w={name:"64-color RGB (6-bit, 2bpc)",type:n.PRGB,useAlpha:!1,data:[[2,2,2]]},v={name:"256-color RGB (8-bit, 3-3-2)",type:n.PRGB,useAlpha:!1,data:[[3,3,2]]},B=e=>{if(e.type!==n.PRGB)throw new Error("Not an RGB palette");const t=e.data[0].map((e=>Math.pow(2,e))),o={name:"EXPANDED_RGB",type:n.POther,useAlpha:!1,data:[]};for(let e=0;e<t[0];e++)for(let n=0;n<t[1];n++)for(let a=0;a<t[2];a++){const r=[e,n,a],s=[e,n,a];for(let e=0;e<3;e++)s[e]=r[e]*(255/(t[e]-1));o.data.push(s)}return o},E=e=>{switch(e.type){case n.PRGB:return Math.pow(2,e.data[0][0])*Math.pow(2,e.data[0][1])*Math.pow(2,e.data[0][2]);case n.PAuto:return e.data[0][0];default:return e.data.length}},P={name:"Macintosh II (1987)",type:n.P4BitIndexed,useAlpha:!1,data:[[255,255,255],[255,255,0],[255,102,0],[221,0,0],[255,0,153],[51,0,153],[0,0,204],[0,153,255],[0,170,0],[0,102,0],[102,51,0],[153,102,51],[187,187,187],[136,136,136],[68,68,68],[0,0,0]]},A={name:"Auto 16-color (4-bit indexed)",type:n.PAuto,useAlpha:!1,data:[[16,-1,4],[1,0,0]]},x={name:"Auto 64-color (6-bit indexed)",type:n.PAuto,useAlpha:!1,data:[[64,1,5],[1,0,0]]},b={name:"Auto 256-color (8-bit indexed)",type:n.PAuto,useAlpha:!1,data:[[256,2,5],[1,0,0]]},C={name:"Black/White (1-bit MC)",type:n.PMono,useAlpha:!1,data:[[0,0,0],[255,255,255]]},I={name:"Black/Green (1-bit MC)",type:n.PMono,useAlpha:!1,data:[[0,0,0],[0,255,0]]},k={name:"Black/Amber (1-bit MC)",type:n.PMono,useAlpha:!1,data:[[0,0,0],[255,200,15]]};class M{constructor(e){var t;this.generated=!1,this.levels=e.levels,this.tree=(t=e.levels,Array.from({length:Math.pow(8,t)},(()=>new class{constructor(){this.colors=[],this.pixels=0}get pixelCount(){return this.pixels}get avgColor(){const e=[0,0,0];for(let t=0;t<this.colors.length;t++)for(let o=0;o<3;o++)e[o]+=this.colors[t][o];return e.map((e=>e/this.colors.length))}addColor(e){this.colors.includes(e)||this.colors.push(e),this.pixels++}}))),this.ctes=[],this.reservedLevel=e.reservedLevel,this.nColors=e.numColors,this.k=e.inclThresholdCoeff||1}addColor(e){if(this.generated)throw new Error("Attempting to modify a generated palette");const t=this.index(e);return this.tree[t].addColor(e),t}getPalette(){this.generated||this.generate();const e=[];return this.ctes.forEach((t=>{const o=t.index,n=[0,0,0];for(let e=0;e<t.level;e++)for(let a=2;a>=0;a--){const r=3*(t.level-1-e)+a,s=1<<3*t.level-1>>3*e+(2-a);n[2-a]=n[2-a]<<1|(o&s)>>r}for(let e=t.level;e<8;e++)for(let o=0;o<3;o++)n[o]=n[o]<<1|(e===t.level?1:0);e.push(n)})),console.log(`Built palette with ${e.length} colors`),e}index(e){let t=0;for(let o=0;o<this.levels;o++){const n=7-o;let a=0;for(let t=0;t<3;t++){const r=128>>o;a=a<<1|(e[t]&r)>>n}t=t<<3|a}return t}getNode(e,t){if(t===this.levels)return this.tree[e];const o=[];for(let n=0;n<8;n++)this.isCTE(8*e+n,t+1)||o.push(this.getNode(8*e+n,t+1));return o.filter((e=>e.pixelCount>0)).reduce(((e,t)=>({pixelCount:e.pixelCount+t.pixelCount})),{pixelCount:0})}isCTE(e,t){return this.ctes.some((o=>o.index===e&&o.level===t))}markCTE(e,t,o){this.ctes.push({index:e,level:t,node:o})}testNode(e,t,o,n){const a=e-t-this.ctes.length,r=(o-this.ctes.map((e=>e.node.pixelCount)).reduce(((e,t)=>e+t),0))/a*this.k;return n.pixelCount>r}get nonReservedCTEs(){return this.ctes.filter((e=>e.level!==this.reservedLevel)).length}generate(){if(this.generated)throw new Error("This palette has already been generated");this.generated=!0;const e=this.reservedLevel<0?0:Math.pow(8,this.reservedLevel),t=this.getNode(0,0).pixelCount;let o,n=0,a=0;for(;this.nColors-e-this.nonReservedCTEs>0;){for(o=this.levels;o>this.reservedLevel&&o>0;){const n=Math.pow(8,o);for(let a=0;a<n;a++){const n=this.getNode(a,o);if(!this.isCTE(a,o)&&this.testNode(this.nColors,e,t,n)&&this.markCTE(a,o,n),a%8==7){let e=0;for(let t=a-7;t<=a;t++)this.isCTE(t,o)&&e++;if(e>0&&e<8){const e=a>>3;this.isCTE(e,o-1)||this.markCTE(e,o-1,this.getNode(e,o-1))}}if(this.nColors-e-this.nonReservedCTEs<=0)break}if(this.nColors-e-this.nonReservedCTEs<=0)break;o--}if(this.ctes.length===n&&(this.k=this.k/2,a++,a>=5))break;n=this.ctes.length}if(this.reservedLevel>=0){o=this.reservedLevel;const e=Math.pow(8,o);for(let t=0;t<e;t++){const e=this.getNode(t,o);this.isCTE(t,o)||this.markCTE(t,o,e)}}}}const T=[];function G(){return new Worker(o.p+"main.worker.js")}var L;!function(e){e[e.Progress=0]="Progress",e[e.Done=1]="Done",e[e.Error=2]="Error"}(L||(L={}));const R=class{constructor(){this.busy=!1,this.x=0,this.y=0,this.worker=new G,this.worker.onmessage=e=>{const t=e.data;switch(t.msg){case L.Progress:this.onprogress&&this.onprogress(Object.assign(Object.assign({},t.params),{partial:t.params.partial?{data:t.params.partial,x:this.x,y:this.y}:void 0}));break;case L.Done:this.onfinish&&this.onfinish({data:t.params.result,x:this.x,y:this.y}),this.busy=!1;break;case L.Error:this.onerror&&this.onerror(t.params.error),this.busy=!1}}}get ready(){return!this.busy}start(e,t,o,n){return!this.busy&&(this.busy=!0,this.worker.postMessage({dataIn:e.data,palette:t,procId:o,distFnId:n}),!0)}terminate(){this.worker.terminate()}},S=navigator.hardwareConcurrency,$=Math.max(~~(S/2),1),N=[];function O(e,t,o,a,r,s="auto"){return new Promise(((i,l)=>{t.width=e.width,t.height=e.height;const d=e.getContext("2d");if(!d)throw new Error("Unable to get input context");const c=t.getContext("2d");if(!c)throw new Error("Unable to get output context");let h=(new Date).getTime();const u=d.getImageData(0,0,e.width,e.height);let p;if(o=function(e,t,o){return e.type===n.PAuto?function(e,t){const o=`AUTO_${e.data[0][0]}_${e.data[1][2]}`,a=T.find((e=>e.key===o));if(a)return a.palette;{const a=function(e,t){const o=new M(e),a=t.width*t.height*4;for(let e=0;e<a;e+=4){const n=~~(e/4/t.width);if(~~(e/4%t.width)%2==0&&n%2==0){const n=Array.from(t.data.slice(e,e+4));o.addColor(n)}}const r=o.getPalette();return{name:"__GENERATED__",type:n.POther,useAlpha:!1,data:r}}({numColors:e.data[0][0],reservedLevel:e.data[0][1],levels:e.data[0][2],inclThresholdCoeff:e.data[1][0]},t);return T.push({key:o,palette:a}),a}}(e,o):t.id.includes("BayerLike")&&e.type===n.PRGB?B(e):e}(o,a,u),console.log(`Palette processing done in ${(new Date).getTime()-h}ms`),a.supportsMultipleThreads)if("auto"===s){const t=((e,t)=>e.complexity(E(t)))(a,o),n=e.width*e.height,r=~~(n/5e4*t/2048);p=r<1?1:r>$?$:r,console.log(`Want ${r} threads for ${n}px @CR${t}, got ${p} (max ${$})`)}else p=s;else p=1;let m=0;const g=8*~~(e.width/p/8),f=e.width-g*p;h=(new Date).getTime();for(let t=0;t<p;t++){const n=~~(f/8),s=t*g+8*(n<t?n:t),u=g+(t===p-1?f%8:n>t?8:0),y=d.getImageData(s,0,u,e.height);y||l("Unable to get image data from context");const w={data:y,x:s,y:0},v=new R;v.onprogress=e=>{e.partial&&c.putImageData(e.partial.data,s,0),c.fillStyle="#ff00ff",c.fillRect(s,e.current/(4*u),u,2)},v.onfinish=e=>{c.putImageData(e.data,s,0),m--,N.splice(N.indexOf(v),1);const o=(new Date).getTime();console.log(`Worker thread ${t+1} done in ${o-h}ms`),0===m&&(console.log(`${p} worker threads done in ${o-h}ms`),i())},v.onerror=e=>l(`Error in worker thread: ${e}`),console.log(`Starting worker thread ${t+1}/${p} w=${u}`),v.start(w,o,a.id,r),m++,N.push(v)}}))}function D(e,t,o){switch(t.type){case n.PRGB:return function(e,t){const o=t.data[0].map((e=>Math.pow(2,e))),n=[...e];for(let t=0;t<3;t++){const a=~~(e[t]/(256/o[t]));n[t]=a*(255/(o[t]-1))}return n}(e,t);default:return function(e,t,o){let n=[],a=Number.POSITIVE_INFINITY;return t.data.forEach((t=>{const r=o(e,t);r<=a&&(n=t,a=r)})),n}(e,t,o)}}const F={id:"ProcBasic",name:"Basic (no dithering)",procFn:(e,t,o,n)=>{const a=4*e.width,r=e.width*e.height*4;for(let s=0;s<r;s+=4){const i=D(Array.from(e.data.slice(s,s+4)),t,o);for(let t=0;t<3;t++)e.data[s+t]=i[t];s%(8*a)==0&&n&&n(s,r,e)}return e},maxAllowedPaletteSize:65536,supportsMultipleThreads:!1,complexity:e=>e},_={id:"ProcFloydSteinberg",name:"Floyd–Steinberg",procFn:(e,t,o,n)=>{const a=e.width*e.height*4,r=4*e.width;for(let s=0;s<a;s+=4){const i=Array.from(e.data.slice(s,s+4)),l=D(i,t,o);for(let t=0;t<3;t++)e.data[s+t]=l[t];const d=i.map(((e,t)=>e-l[t]));for(let t=0;t<3;t++)e.data[s+4+t]+=7*d[t]/16,e.data[s+r-4+t]+=3*d[t]/16,e.data[s+r+t]+=5*d[t]/16,e.data[s+r+4+t]+=1*d[t]/16;s%(4*r)==0&&n&&n(s,a,e)}return e},maxAllowedPaletteSize:65536,supportsMultipleThreads:!1,complexity:e=>e},z=[0,48,12,60,3,51,15,63,32,16,44,28,35,19,47,31,8,56,4,52,11,59,7,55,40,24,36,20,43,27,39,23,2,50,14,62,1,49,13,61,34,18,46,30,33,17,45,29,10,58,6,54,9,57,5,53,42,26,38,22,41,25,37,21].map((e=>e/64));function W(e,t,o,n,a){return a(e,t)+o*((n<0?-n:n)+.5)}function U(e=!0){return(t,o,a,r)=>{o.type===n.PRGB&&(o=B(o));const s=t.width*t.height*4,i=4*t.width,l={};for(let e=0;e<o.data.length;e++)for(let t=e;t<o.data.length;t++)l[e*o.data.length+t]=.1*a(o.data[e],o.data[t]);const d=[0,0,0];let c,h,u,p;for(let n=0;n<s;n+=4){c=Array.from(t.data.slice(n,n+4));const m=z[n%i/4%8+~~(n/i)%8*8];p={color1:[0,0,0],color2:c,ratio:.33};let g=Number.MAX_VALUE;for(let t=0;t<o.data.length;t++)for(let n=t;n<o.data.length;n++)if(h=o.data[t],u=o.data[n],e){let e=32;t!==n&&(e=((h[0]!==u[0]?19136*(c[0]-h[0])/(u[0]-h[0]):0)+(h[1]!==u[1]?37568*(c[1]-h[1])/(u[1]-h[1]):0)+(h[2]!==u[2]?7296*(c[2]-h[2])/(u[2]-h[2]):0))/((h[0]!==u[0]?299:0)+(h[1]!==u[1]?587:0)+(h[2]!==u[2]?114:0)),e<0?e=0:e>63&&(e=63),e=~~e);const r=e/64;for(let e=0;e<3;e++)d[e]=h[e]+r*(u[e]-h[e]);const s=W(c,d,l[t*o.data.length+n],r-.5,a);s<g&&(g=s,p.color1=h,p.color2=u,p.ratio=r)}else for(let e=0;e<64&&!(t===n&&e>0);e++){const r=e/64;for(let e=0;e<3;e++)d[e]=h[e]+r*(u[e]-h[e]);const s=W(c,d,l[t*o.data.length+n],r-.5,a);s<g&&(g=s,p.color1=h,p.color2=u,p.ratio=r)}for(let e=0;e<3;e++)t.data[n+e]=m<p.ratio?p.color2[e]:p.color1[e];n%(4*i)==0&&r&&r(n,s,t)}return t}}const j={id:"ProcBayerLikeFast",name:"Ordered (Bayer-like) – Fast",procFn:U(),maxAllowedPaletteSize:192,supportsMultipleThreads:!0,complexity:e=>e*e/2},H={id:"ProcBayerLikeThorough",name:"Ordered (Bayer-like) – High Quality",procFn:U(!1),maxAllowedPaletteSize:24,supportsMultipleThreads:!0,complexity:e=>e*e*32},V=document.getElementById("canvasOriginal"),X=V.getContext("2d"),Q=document.getElementById("canvasOutput"),Y=document.getElementById("allowSlow"),Z=document.getElementById("slowWarning");Y.addEventListener("change",(function(){Y.checked?Z.style.removeProperty("display"):Z.style.setProperty("display","none"),me(),ge()}));const q=[a,r,s,i,l,d,h,P,u,p,c,m,C,k,I,g,f,y,w,v,A,x,b];let J=u;const K=document.getElementById("paletteSelect");q.forEach((e=>{const t=document.createElement("option");let o;t.setAttribute("value",e.name),t.text=e.name;const n=K.getElementsByTagName("optgroup");for(let t=0;t<n.length;t++)n[t].label===e.type&&(o=n[t]);o||(o=document.createElement("optgroup"),o.label=e.type,K.appendChild(o)),o.appendChild(t)})),K.value=J.name;const ee=[F,_,j,H];let te=F;const oe=document.getElementById("processSelect");ee.forEach((e=>{const t=document.createElement("option");t.setAttribute("value",e.name),t.text=e.name,oe.appendChild(t)}));const ne=document.getElementById("useLab");ne.addEventListener("change",(function(){pe()})),K.addEventListener("change",(function(e){J=q.find((t=>t.name===e.target.value))||J,me(),pe()})),oe.addEventListener("change",(function(e){te=ee.find((t=>t.name===e.target.value))||te,ge(),pe()}));const ae=document.getElementById("resizeInput");document.getElementById("fileInput").addEventListener("change",(function(e){var t;(t=e,new Promise(((e,o)=>{const n=t.target;if(null==n?void 0:n.files){const t=n.files[0],o=new Image;o.onload=()=>e(o),o.src=URL.createObjectURL(t)}else o()}))).then((e=>function(e){let t=e.width,o=e.height;const n=parseInt(ae.value,10);t>=o&&t>n&&(o=n*(o/t),t=n),o>t&&o>n&&(t=n*(t/o),o=n),V.width=t,V.height=o,null==X||X.drawImage(e,0,0,t,o),T.splice(0),pe()}(e)))})),document.getElementById("toggleOriginal").addEventListener("click",(function(){Q.classList.contains("clip")?Q.classList.remove("clip"):Q.classList.add("clip")}));const re=document.getElementById("advancedOptions"),se=document.getElementById("toggleAdvanced");se.addEventListener("click",(function(){const e="none"!==getComputedStyle(re).getPropertyValue("display");e?re.style.setProperty("display","none"):re.style.removeProperty("display"),se.innerHTML=(e?"Show":"Hide")+" advanced options"}));const ie=document.getElementById("useThreads"),le=document.getElementById("threadModeAuto"),de=document.getElementById("threadModeManual"),ce=document.getElementById("threadCount");function he(){le.disabled=!ie.checked,de.disabled=!ie.checked,ce.disabled=!ie.checked||!de.checked}ce.value="2",ce.min="1",ce.max=S.toString(),ie.addEventListener("change",he),le.addEventListener("change",he),de.addEventListener("change",he),ce.addEventListener("change",he);const ue=document.getElementById("abort");function pe(){Q.classList.remove("flash-anim");const e=ie.checked?le.checked?"auto":parseInt(ce.value,10):1;ue.disabled=!1,O(V,Q,J,te,ne.checked?"cdLab":"cdRGB",e).then((()=>{Q.classList.add("flash-anim"),ue.disabled=!0}))}function me(){const e=oe.children;for(let t=0;t<e.length;t++){const o=e[t],n=ee.find((e=>e.name===o.value));n&&(o.disabled=!Y.checked&&n.maxAllowedPaletteSize<E(J))}}function ge(){const e=K.getElementsByTagName("option");for(let t=0;t<e.length;t++){const o=e[t],n=q.find((e=>e.name===o.value));n&&(o.disabled=!Y.checked&&te.maxAllowedPaletteSize<E(n))}}ue.addEventListener("click",(()=>{N.forEach((e=>e.terminate())),N.splice(0),ue.disabled=!0}))})();