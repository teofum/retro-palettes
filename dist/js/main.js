(()=>{"use strict";var t,e,a={};a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),(()=>{var t;a.g.importScripts&&(t=a.g.location+"");var e=a.g.document;if(!t&&e&&(e.currentScript&&(t=e.currentScript.src),!t)){var n=e.getElementsByTagName("script");n.length&&(t=n[n.length-1].src)}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),a.p=t})(),(e=t||(t={})).P2BitIndexed="2-bit (4 color) Indexed",e.P4BitRGBI="4-bit (16 color) RGBI",e.P4BitIndexed="4-bit (16 color) Indexed",e.PMono="Monochrome",e.PRGB="RGB",e.PAuto="Other",e.POther="Other";const n=t,o={name:"CGA Mode 4 Palette 0 (low)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[0,170,0],[170,0,0],[170,85,0]]},r={name:"CGA Mode 4 Palette 0 (high)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[85,255,85],[255,85,85],[255,255,85]]},i={name:"CGA Mode 4 Palette 1 (low)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[0,170,170],[170,0,170],[170,170,170]]},s={name:"CGA Mode 4 Palette 1 (high)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[85,255,255],[255,85,255],[255,255,255]]},d={name:"CGA Mode 5 (low)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[0,170,170],[170,0,0],[170,170,170]]},l={name:"CGA Mode 5 (high)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[85,255,255],[255,85,85],[255,255,255]]},c={name:"CGA 4-bit RGBI (IBM)",type:n.P4BitRGBI,useAlpha:!1,data:[[0,0,0],[0,0,170],[0,170,0],[0,170,170],[170,0,0],[170,0,170],[170,85,0],[170,170,170],[85,85,85],[85,85,255],[85,255,85],[85,255,255],[255,85,85],[255,85,255],[255,255,85],[255,255,255]]},h={name:"Commodore 64",type:n.P4BitIndexed,useAlpha:!1,data:[[0,0,0],[98,98,82],[137,137,137],[173,173,173],[255,255,255],[159,78,68],[203,126,117],[109,84,18],[161,104,60],[201,212,135],[154,226,155],[92,171,94],[106,191,198],[136,126,203],[80,69,155],[160,87,163]]},u={name:"Windows 4-bit RGBI",type:n.P4BitRGBI,useAlpha:!1,data:[[0,0,0],[0,0,128],[0,128,0],[0,128,128],[128,0,0],[128,0,128],[128,128,0],[192,192,192],[128,128,128],[0,0,255],[0,255,0],[0,255,255],[255,0,0],[255,0,255],[255,255,0],[255,255,255]]},p={name:"Windows 20-color Extended RGBI",type:n.P4BitIndexed,useAlpha:!1,data:[[0,0,0],[0,0,128],[0,128,0],[0,128,128],[128,0,0],[128,0,128],[128,128,0],[192,192,192],[192,220,192],[166,202,240],[255,251,240],[160,160,164],[128,128,128],[0,0,255],[0,255,0],[0,255,255],[255,0,0],[255,0,255],[255,255,0],[255,255,255]]},m={name:"ZX Spectrum 4-bit RGBI",type:n.P4BitRGBI,useAlpha:!1,data:[[0,0,0],[0,0,215],[0,215,0],[0,215,215],[215,0,0],[215,0,215],[215,215,0],[215,215,215],[0,0,255],[0,255,0],[0,255,255],[255,0,0],[255,0,255],[255,255,0],[255,255,255]]},g={name:"Game Boy Green (2-bit MC)",type:n.PMono,useAlpha:!1,data:[[15,56,15],[48,98,48],[139,172,15],[155,188,15]]},f={name:"Game Boy White (2-bit MC)",type:n.PMono,useAlpha:!1,data:[[0,0,0],[85,85,85],[170,170,170],[255,255,255]]},y={name:"8-color RGB (3-bit, 1bpc)",type:n.PRGB,useAlpha:!1,data:[[1,1,1]]},B={name:"64-color RGB (6-bit, 2bpc)",type:n.PRGB,useAlpha:!1,data:[[2,2,2]]},P={name:"256-color RGB (8-bit, 3-3-2)",type:n.PRGB,useAlpha:!1,data:[[3,3,2]]},I={name:"Macintosh II (1987)",type:n.P4BitIndexed,useAlpha:!1,data:[[255,255,255],[255,255,0],[255,102,0],[221,0,0],[255,0,153],[51,0,153],[0,0,204],[0,153,255],[0,170,0],[0,102,0],[102,51,0],[153,102,51],[187,187,187],[136,136,136],[68,68,68],[0,0,0]]},b={name:"Auto 16-color (4-bit indexed)",type:n.PAuto,useAlpha:!1,data:[[16,-1,4],[1,0,0]]},w={name:"Auto 64-color (6-bit indexed)",type:n.PAuto,useAlpha:!1,data:[[64,1,5],[1,0,0]]},A={name:"Auto 256-color (8-bit indexed)",type:n.PAuto,useAlpha:!1,data:[[256,2,5],[1,0,0]]},E={name:"Black/White (1-bit MC)",type:n.PMono,useAlpha:!1,data:[[0,0,0],[255,255,255]]},G={name:"Black/Green (1-bit MC)",type:n.PMono,useAlpha:!1,data:[[0,0,0],[0,255,0]]},x={name:"Black/Amber (1-bit MC)",type:n.PMono,useAlpha:!1,data:[[0,0,0],[255,200,15]]},R=[];function M(t,e,a){switch(e.type){case n.PRGB:return function(t,e){const a=e.data[0].map((t=>Math.pow(2,t))),n=[...t];for(let e=0;e<3;e++){const o=~~(t[e]/(256/a[e]));n[e]=o*(255/(a[e]-1))}return n}(t,e);default:return function(t,e,a){let n=[],o=Number.POSITIVE_INFINITY;return e.data.forEach((e=>{const r=a(t,e);r<=o&&(n=e,o=r)})),n}(t,e,a)}}const v={id:"ProcBasic",name:"Basic (no dithering)",function:(t,e,a,n)=>{const o=4*t.width,r=t.width*t.height*4;for(let i=0;i<r;i+=4){const s=M(Array.from(t.data.slice(i,i+4)),e,a);for(let e=0;e<3;e++)t.data[i+e]=s[e];i%o==0&&n&&n(i,r,t)}return t}},C={id:"ProcFloydSteinberg",name:"Floyd–Steinberg",function:(t,e,a,n)=>{const o=t.width*t.height*4,r=4*t.width;for(let i=0;i<o;i+=4){const s=Array.from(t.data.slice(i,i+4)),d=M(s,e,a);for(let e=0;e<3;e++)t.data[i+e]=d[e];const l=s.map(((t,e)=>t-d[e]));for(let e=0;e<3;e++)t.data[i+4+e]+=7*l[e]/16,t.data[i+r-4+e]+=3*l[e]/16,t.data[i+r+e]+=5*l[e]/16,t.data[i+r+4+e]+=1*l[e]/16;i%r==0&&n&&n(i,o,t)}return t}},k=[0,48,12,60,3,51,15,63,32,16,44,28,35,19,47,31,8,56,4,52,11,59,7,55,40,24,36,20,43,27,39,23,2,50,14,62,1,49,13,61,34,18,46,30,33,17,45,29,10,58,6,54,9,57,5,53,42,26,38,22,41,25,37,21].map((t=>t/64));function L(t,e,a,n,o){return o(t,e)+a*((n<0?-n:n)+.5)}function O(t=!0){return(e,a,o,r)=>{a.type===n.PRGB&&(a=(t=>{if(t.type!==n.PRGB)throw new Error("Not an RGB palette");const e=t.data[0].map((t=>Math.pow(2,t))),a={name:"EXPANDED_RGB",type:n.POther,useAlpha:!1,data:[]};for(let t=0;t<e[0];t++)for(let n=0;n<e[1];n++)for(let o=0;o<e[2];o++){const r=[t,n,o],i=[t,n,o];for(let t=0;t<3;t++)i[t]=r[t]*(255/(e[t]-1));a.data.push(i)}return a})(a));const i=e.width*e.height*4,s=4*e.width,d={};for(let t=0;t<a.data.length;t++)for(let e=t;e<a.data.length;e++)d[t*a.data.length+e]=.1*o(a.data[t],a.data[e]);const l=[0,0,0];let c,h,u,p;for(let n=0;n<i;n+=4){c=Array.from(e.data.slice(n,n+4));const m=k[n%s/4%8+~~(n/s)%8*8];p={color1:[0,0,0],color2:c,ratio:.33};let g=Number.MAX_VALUE;for(let e=0;e<a.data.length;e++)for(let n=e;n<a.data.length;n++)if(h=a.data[e],u=a.data[n],t){let t=32;e!==n&&(t=((h[0]!==u[0]?19136*(c[0]-h[0])/(u[0]-h[0]):0)+(h[1]!==u[1]?37568*(c[1]-h[1])/(u[1]-h[1]):0)+(h[2]!==u[2]?7296*(c[2]-h[2])/(u[2]-h[2]):0))/((h[0]!==u[0]?299:0)+(h[1]!==u[1]?587:0)+(h[2]!==u[2]?114:0)),t<0?t=0:t>63&&(t=63),t=~~t);const r=t/64;for(let t=0;t<3;t++)l[t]=h[t]+r*(u[t]-h[t]);const i=L(c,l,d[e*a.data.length+n],r-.5,o);i<g&&(g=i,p.color1=h,p.color2=u,p.ratio=r)}else for(let t=0;t<64&&!(e===n&&t>0);t++){const r=t/64;for(let t=0;t<3;t++)l[t]=h[t]+r*(u[t]-h[t]);const i=L(c,l,d[e*a.data.length+n],r-.5,o);i<g&&(g=i,p.color1=h,p.color2=u,p.ratio=r)}for(let t=0;t<3;t++)e.data[n+t]=m<p.ratio?p.color2[t]:p.color1[t];n%s==0&&r&&r(n,i,e)}return e}}const S={id:"ProcBayerLikeFast",name:"Ordered (Bayer-like) – Fast",function:O()},D={id:"ProcBayerLikeThorough",name:"Ordered (Bayer-like) – Precise (!SLOW!)",function:O(!1)};function N(){return new Worker(a.p+"main.worker.js")}var F;!function(t){t[t.Progress=0]="Progress",t[t.Done=1]="Done",t[t.Error=2]="Error"}(F||(F={}));const T=document.getElementById("canvasOriginal"),U=T.getContext("2d"),W=document.getElementById("canvasOutput"),$=W.getContext("2d"),j=new class{constructor(){this.busy=!1,this.worker=new N,this.worker.onmessage=t=>{const e=t.data;switch(e.msg){case F.Progress:this.onprogress&&this.onprogress(e.params);break;case F.Done:this.onfinish&&this.onfinish(e.params.result),this.busy=!1;break;case F.Error:this.onerror&&this.onerror(e.params.error),this.busy=!1}}}get ready(){return!this.busy}start(t,e,a,n){return!this.busy&&(this.busy=!0,this.worker.postMessage({dataIn:t,palette:e,procId:a,distFnId:n}),!0)}};j.onfinish=t=>null==$?void 0:$.putImageData(t,0,0),j.onprogress=t=>{const e=t.current/4/T.width,a=t.total/4/T.width;console.log(`Processed ${e}/${a} lines`),t.partial&&(null==$||$.putImageData(t.partial,0,0))};const X=[o,r,i,s,d,l,h,I,u,p,c,m,E,x,G,g,f,y,B,P,b,w,A];let _=u;const V=document.getElementById("paletteSelect");X.forEach((t=>{const e=document.createElement("option");let a;e.setAttribute("value",t.name),e.text=t.name;const n=V.getElementsByTagName("optgroup");for(let e=0;e<n.length;e++)n[e].label===t.type&&(a=n[e]);a||(a=document.createElement("optgroup"),a.label=t.type,V.appendChild(a)),a.appendChild(e)})),V.value=_.name;const z=[v,C,S,D];let Y=v;const Z=document.getElementById("processSelect");z.forEach((t=>{const e=document.createElement("option");e.setAttribute("value",t.name),e.text=t.name,Z.appendChild(e)}));const q=document.getElementById("useLab");q.addEventListener("change",(function(){J()})),V.addEventListener("change",(function(t){_=X.find((e=>e.name===t.target.value))||_,J()})),Z.addEventListener("change",(function(t){Y=z.find((e=>e.name===t.target.value))||Y,J()}));const H=document.getElementById("resizeInput");function J(){j.ready&&function(t,e,a,n,o,r){e.width=t.width,e.height=t.height;const i=t.getContext("2d");if(!i)throw new Error("Unable to get input context");if(!e.getContext("2d"))throw new Error("Unable to get output context");const s=i.getImageData(0,0,t.width,t.height);if(!s)throw new Error("Unable to get image data from context");r.start(s,a,n.id,o)}(T,W,_,Y,q.checked?"cdLab":"cdRGB",j)}document.getElementById("fileInput").addEventListener("change",(function(t){var e;(e=t,new Promise(((t,a)=>{const n=e.target;if(null==n?void 0:n.files){const e=n.files[0],a=new Image;a.onload=()=>t(a),a.src=URL.createObjectURL(e)}else a()}))).then((t=>function(t){let e=t.width,a=t.height;const n=parseInt(H.value,10);e>=a&&e>n&&(a=n*(a/e),e=n),a>e&&a>n&&(e=n*(e/a),a=n),T.width=e,T.height=a,null==U||U.drawImage(t,0,0,e,a),R.splice(0),J()}(t)))})),document.getElementById("toggleOriginal").addEventListener("click",(function(){W.classList.contains("clip")?W.classList.remove("clip"):W.classList.add("clip")}))})();