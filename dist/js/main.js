(()=>{"use strict";var e,t,a={};a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{var e;a.g.importScripts&&(e=a.g.location+"");var t=a.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");n.length&&(e=n[n.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),a.p=e})(),(t=e||(e={})).P2BitIndexed="2-bit (4 color) Indexed",t.P4BitRGBI="4-bit (16 color) RGBI",t.P4BitIndexed="4-bit (16 color) Indexed",t.PMono="Monochrome",t.PRGB="RGB",t.PAuto="Optimized (Auto)",t.POther="Other";const n=e,o={name:"CGA Mode 4 Palette 0 (low)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[0,170,0],[170,0,0],[170,85,0]]},r={name:"CGA Mode 4 Palette 0 (high)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[85,255,85],[255,85,85],[255,255,85]]},i={name:"CGA Mode 4 Palette 1 (low)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[0,170,170],[170,0,170],[170,170,170]]},l={name:"CGA Mode 4 Palette 1 (high)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[85,255,255],[255,85,255],[255,255,255]]},d={name:"CGA Mode 5 (low)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[0,170,170],[170,0,0],[170,170,170]]},s={name:"CGA Mode 5 (high)",type:n.P2BitIndexed,useAlpha:!1,data:[[0,0,0],[85,255,255],[255,85,85],[255,255,255]]},c={name:"CGA 4-bit RGBI (IBM)",type:n.P4BitRGBI,useAlpha:!1,data:[[0,0,0],[0,0,170],[0,170,0],[0,170,170],[170,0,0],[170,0,170],[170,85,0],[170,170,170],[85,85,85],[85,85,255],[85,255,85],[85,255,255],[255,85,85],[255,85,255],[255,255,85],[255,255,255]]},u={name:"Commodore 64",type:n.P4BitIndexed,useAlpha:!1,data:[[0,0,0],[98,98,82],[137,137,137],[173,173,173],[255,255,255],[159,78,68],[203,126,117],[109,84,18],[161,104,60],[201,212,135],[154,226,155],[92,171,94],[106,191,198],[136,126,203],[80,69,155],[160,87,163]]},h={name:"Windows 4-bit RGBI",type:n.P4BitRGBI,useAlpha:!1,data:[[0,0,0],[0,0,128],[0,128,0],[0,128,128],[128,0,0],[128,0,128],[128,128,0],[192,192,192],[128,128,128],[0,0,255],[0,255,0],[0,255,255],[255,0,0],[255,0,255],[255,255,0],[255,255,255]]},p={name:"Windows 20-color Extended RGBI",type:n.P4BitIndexed,useAlpha:!1,data:[[0,0,0],[0,0,128],[0,128,0],[0,128,128],[128,0,0],[128,0,128],[128,128,0],[192,192,192],[192,220,192],[166,202,240],[255,251,240],[160,160,164],[128,128,128],[0,0,255],[0,255,0],[0,255,255],[255,0,0],[255,0,255],[255,255,0],[255,255,255]]},m={name:"ZX Spectrum 4-bit RGBI",type:n.P4BitRGBI,useAlpha:!1,data:[[0,0,0],[0,0,215],[0,215,0],[0,215,215],[215,0,0],[215,0,215],[215,215,0],[215,215,215],[0,0,255],[0,255,0],[0,255,255],[255,0,0],[255,0,255],[255,255,0],[255,255,255]]},g={name:"Game Boy Green (2-bit MC)",type:n.PMono,useAlpha:!1,data:[[15,56,15],[48,98,48],[139,172,15],[155,188,15]]},f={name:"Game Boy White (2-bit MC)",type:n.PMono,useAlpha:!1,data:[[0,0,0],[85,85,85],[170,170,170],[255,255,255]]},y={name:"8-color RGB (3-bit, 1bpc)",type:n.PRGB,useAlpha:!1,data:[[1,1,1]]},B={name:"64-color RGB (6-bit, 2bpc)",type:n.PRGB,useAlpha:!1,data:[[2,2,2]]},P={name:"256-color RGB (8-bit, 3-3-2)",type:n.PRGB,useAlpha:!1,data:[[3,3,2]]},w={name:"Macintosh II (1987)",type:n.P4BitIndexed,useAlpha:!1,data:[[255,255,255],[255,255,0],[255,102,0],[221,0,0],[255,0,153],[51,0,153],[0,0,204],[0,153,255],[0,170,0],[0,102,0],[102,51,0],[153,102,51],[187,187,187],[136,136,136],[68,68,68],[0,0,0]]},A={name:"Auto 16-color (4-bit indexed)",type:n.PAuto,useAlpha:!1,data:[[16,-1,4],[1,0,0]]},I={name:"Auto 64-color (6-bit indexed)",type:n.PAuto,useAlpha:!1,data:[[64,1,5],[1,0,0]]},b={name:"Auto 256-color (8-bit indexed)",type:n.PAuto,useAlpha:!1,data:[[256,2,5],[1,0,0]]},E={name:"Black/White (1-bit MC)",type:n.PMono,useAlpha:!1,data:[[0,0,0],[255,255,255]]},G={name:"Black/Green (1-bit MC)",type:n.PMono,useAlpha:!1,data:[[0,0,0],[0,255,0]]},x={name:"Black/Amber (1-bit MC)",type:n.PMono,useAlpha:!1,data:[[0,0,0],[255,200,15]]},M=[];function v(e,t,a){switch(t.type){case n.PRGB:return function(e,t){const a=t.data[0].map((e=>Math.pow(2,e))),n=[...e];for(let t=0;t<3;t++){const o=~~(e[t]/(256/a[t]));n[t]=o*(255/(a[t]-1))}return n}(e,t);default:return function(e,t,a){let n=[],o=Number.POSITIVE_INFINITY;return t.data.forEach((t=>{const r=a(e,t);r<=o&&(n=t,o=r)})),n}(e,t,a)}}const R={id:"ProcBasic",name:"Basic (no dithering)",maxAllowedPaletteSize:65536,function:(e,t,a,n)=>{const o=4*e.width,r=e.width*e.height*4;for(let i=0;i<r;i+=4){const l=v(Array.from(e.data.slice(i,i+4)),t,a);for(let t=0;t<3;t++)e.data[i+t]=l[t];i%o==0&&n&&n(i,r,e)}return e}},C={id:"ProcFloydSteinberg",name:"Floyd–Steinberg",maxAllowedPaletteSize:65536,function:(e,t,a,n)=>{const o=e.width*e.height*4,r=4*e.width;for(let i=0;i<o;i+=4){const l=Array.from(e.data.slice(i,i+4)),d=v(l,t,a);for(let t=0;t<3;t++)e.data[i+t]=d[t];const s=l.map(((e,t)=>e-d[t]));for(let t=0;t<3;t++)e.data[i+4+t]+=7*s[t]/16,e.data[i+r-4+t]+=3*s[t]/16,e.data[i+r+t]+=5*s[t]/16,e.data[i+r+4+t]+=1*s[t]/16;i%r==0&&n&&n(i,o,e)}return e}},k=[0,48,12,60,3,51,15,63,32,16,44,28,35,19,47,31,8,56,4,52,11,59,7,55,40,24,36,20,43,27,39,23,2,50,14,62,1,49,13,61,34,18,46,30,33,17,45,29,10,58,6,54,9,57,5,53,42,26,38,22,41,25,37,21].map((e=>e/64));function L(e,t,a,n,o){return o(e,t)+a*((n<0?-n:n)+.5)}function S(e=!0){return(t,a,o,r)=>{a.type===n.PRGB&&(a=(e=>{if(e.type!==n.PRGB)throw new Error("Not an RGB palette");const t=e.data[0].map((e=>Math.pow(2,e))),a={name:"EXPANDED_RGB",type:n.POther,useAlpha:!1,data:[]};for(let e=0;e<t[0];e++)for(let n=0;n<t[1];n++)for(let o=0;o<t[2];o++){const r=[e,n,o],i=[e,n,o];for(let e=0;e<3;e++)i[e]=r[e]*(255/(t[e]-1));a.data.push(i)}return a})(a));const i=t.width*t.height*4,l=4*t.width,d={};for(let e=0;e<a.data.length;e++)for(let t=e;t<a.data.length;t++)d[e*a.data.length+t]=.1*o(a.data[e],a.data[t]);const s=[0,0,0];let c,u,h,p;for(let n=0;n<i;n+=4){c=Array.from(t.data.slice(n,n+4));const m=k[n%l/4%8+~~(n/l)%8*8];p={color1:[0,0,0],color2:c,ratio:.33};let g=Number.MAX_VALUE;for(let t=0;t<a.data.length;t++)for(let n=t;n<a.data.length;n++)if(u=a.data[t],h=a.data[n],e){let e=32;t!==n&&(e=((u[0]!==h[0]?19136*(c[0]-u[0])/(h[0]-u[0]):0)+(u[1]!==h[1]?37568*(c[1]-u[1])/(h[1]-u[1]):0)+(u[2]!==h[2]?7296*(c[2]-u[2])/(h[2]-u[2]):0))/((u[0]!==h[0]?299:0)+(u[1]!==h[1]?587:0)+(u[2]!==h[2]?114:0)),e<0?e=0:e>63&&(e=63),e=~~e);const r=e/64;for(let e=0;e<3;e++)s[e]=u[e]+r*(h[e]-u[e]);const i=L(c,s,d[t*a.data.length+n],r-.5,o);i<g&&(g=i,p.color1=u,p.color2=h,p.ratio=r)}else for(let e=0;e<64&&!(t===n&&e>0);e++){const r=e/64;for(let e=0;e<3;e++)s[e]=u[e]+r*(h[e]-u[e]);const i=L(c,s,d[t*a.data.length+n],r-.5,o);i<g&&(g=i,p.color1=u,p.color2=h,p.ratio=r)}for(let e=0;e<3;e++)t.data[n+e]=m<p.ratio?p.color2[e]:p.color1[e];n%l==0&&r&&r(n,i,t)}return t}}const O={id:"ProcBayerLikeFast",name:"Ordered (Bayer-like) – Fast",maxAllowedPaletteSize:64,function:S()},N={id:"ProcBayerLikeThorough",name:"Ordered (Bayer-like) – Precise (!SLOW!)",maxAllowedPaletteSize:16,function:S(!1)};function z(){return new Worker(a.p+"main.worker.js")}var D;!function(e){e[e.Progress=0]="Progress",e[e.Done=1]="Done",e[e.Error=2]="Error"}(D||(D={}));function T(e){switch(e.type){case n.PRGB:return Math.pow(2,e.data[0][0])*Math.pow(2,e.data[0][1])*Math.pow(2,e.data[0][2]);case n.PAuto:return e.data[0][0];default:return e.data.length}}const F=document.getElementById("canvasOriginal"),W=F.getContext("2d"),U=document.getElementById("canvasOutput"),j=U.getContext("2d"),X=document.getElementById("allowSlow"),$=document.getElementById("slowWarning");X.addEventListener("change",(function(){X.checked?$.style.removeProperty("display"):$.style.setProperty("display","none"),te(),ae()}));const _=new class{constructor(){this.busy=!1,this.worker=new z,this.worker.onmessage=e=>{const t=e.data;switch(t.msg){case D.Progress:this.onprogress&&this.onprogress(t.params);break;case D.Done:this.onfinish&&this.onfinish(t.params.result),this.busy=!1;break;case D.Error:this.onerror&&this.onerror(t.params.error),this.busy=!1}}}get ready(){return!this.busy}start(e,t,a,n){return!this.busy&&(this.busy=!0,this.worker.postMessage({dataIn:e,palette:t,procId:a,distFnId:n}),!0)}};_.onfinish=e=>{null==j||j.putImageData(e,0,0),U.classList.add("flash-anim")},_.onprogress=e=>{e.partial&&(null==j||j.putImageData(e.partial,0,0))};const V=[o,r,i,l,d,s,u,w,h,p,c,m,E,x,G,g,f,y,B,P,A,I,b];let Y=h;const Z=document.getElementById("paletteSelect");V.forEach((e=>{const t=document.createElement("option");let a;t.setAttribute("value",e.name),t.text=e.name;const n=Z.getElementsByTagName("optgroup");for(let t=0;t<n.length;t++)n[t].label===e.type&&(a=n[t]);a||(a=document.createElement("optgroup"),a.label=e.type,Z.appendChild(a)),a.appendChild(t)})),Z.value=Y.name;const q=[R,C,O,N];let H=R;const J=document.getElementById("processSelect");q.forEach((e=>{const t=document.createElement("option");t.setAttribute("value",e.name),t.text=e.name,J.appendChild(t)}));const K=document.getElementById("useLab");K.addEventListener("change",(function(){ee()})),Z.addEventListener("change",(function(e){Y=V.find((t=>t.name===e.target.value))||Y,te(),ee()})),J.addEventListener("change",(function(e){H=q.find((t=>t.name===e.target.value))||H,ae(),ee()}));const Q=document.getElementById("resizeInput");function ee(){_.ready&&(U.classList.remove("flash-anim"),function(e,t,a,n,o,r){t.width=e.width,t.height=e.height;const i=e.getContext("2d");if(!i)throw new Error("Unable to get input context");if(!t.getContext("2d"))throw new Error("Unable to get output context");const l=i.getImageData(0,0,e.width,e.height);if(!l)throw new Error("Unable to get image data from context");r.start(l,a,n.id,o)}(F,U,Y,H,K.checked?"cdLab":"cdRGB",_))}function te(){const e=J.children;for(let t=0;t<e.length;t++){const a=e[t],n=q.find((e=>e.name===a.value));n&&(a.disabled=!X.checked&&n.maxAllowedPaletteSize<T(Y))}}function ae(){const e=Z.getElementsByTagName("option");for(let t=0;t<e.length;t++){const a=e[t],n=V.find((e=>e.name===a.value));n&&(a.disabled=!X.checked&&H.maxAllowedPaletteSize<T(n))}}document.getElementById("fileInput").addEventListener("change",(function(e){var t;(t=e,new Promise(((e,a)=>{const n=t.target;if(null==n?void 0:n.files){const t=n.files[0],a=new Image;a.onload=()=>e(a),a.src=URL.createObjectURL(t)}else a()}))).then((e=>function(e){let t=e.width,a=e.height;const n=parseInt(Q.value,10);t>=a&&t>n&&(a=n*(a/t),t=n),a>t&&a>n&&(t=n*(t/a),a=n),F.width=t,F.height=a,null==W||W.drawImage(e,0,0,t,a),M.splice(0),ee()}(e)))})),document.getElementById("toggleOriginal").addEventListener("click",(function(){U.classList.contains("clip")?U.classList.remove("clip"):U.classList.add("clip")}))})();