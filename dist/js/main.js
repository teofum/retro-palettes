(()=>{"use strict";var e,t={};t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{var e;t.g.importScripts&&(e=t.g.location+"");var o=t.g.document;if(!e&&o&&(o.currentScript&&(e=o.currentScript.src),!e)){var r=o.getElementsByTagName("script");r.length&&(e=r[r.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=e})(),function(e){e.CGA2Bit="IBM CGA 2-bit modes",e.RetroPC="Retro PCs",e.RetroVC="Retro Consoles",e.Mono="Monochrome",e.Duo="Dual Tone",e.RGB="RGB",e.CMYK="CMYK",e.Auto="Optimized (Auto)",e.Other="Other",e.Generated="AUTOGENERATED PALETTE",e.Hidden="HIDDEN PALETTE"}(e||(e={}));const o=e;var r;!function(e){e[e.Indexed=0]="Indexed",e[e.Mono=1]="Mono",e[e.RGB=2]="RGB",e[e.Mixer=3]="Mixer",e[e.Auto=4]="Auto"}(r||(r={}));const n=r,a={name:"CGA Mode 4 Palette 0 (low)",type:n.Indexed,group:o.CGA2Bit,data:[0,0,0,0,170,0,170,0,0,170,85,0]},s={name:"CGA Mode 4 Palette 0 (high)",type:n.Indexed,group:o.CGA2Bit,data:[0,0,0,85,255,85,255,85,85,255,255,85]},i={name:"CGA Mode 4 Palette 1 (low)",type:n.Indexed,group:o.CGA2Bit,data:[0,0,0,0,170,170,170,0,170,170,170,170]},l={name:"CGA Mode 4 Palette 1 (high)",type:n.Indexed,group:o.CGA2Bit,data:[0,0,0,85,255,255,255,85,255,255,255,255]},d={name:"CGA Mode 5 (low)",type:n.Indexed,group:o.CGA2Bit,data:[0,0,0,0,170,170,170,0,0,170,170,170]},c={name:"CGA Mode 5 (high)",type:n.Indexed,group:o.CGA2Bit,data:[0,0,0,85,255,255,255,85,85,255,255,255]},h={name:"IBM CGA 4-bit RGBI",type:n.Indexed,group:o.RetroPC,data:[0,0,0,0,0,170,0,170,0,0,170,170,170,0,0,170,0,170,170,85,0,170,170,170,85,85,85,85,85,255,85,255,85,85,255,255,255,85,85,255,85,255,255,255,85,255,255,255]},u={name:"Commodore 64 (*)",type:n.Indexed,group:o.RetroPC,data:[0,0,0,98,98,82,137,137,137,173,173,173,255,255,255,159,78,68,203,126,117,109,84,18,161,104,60,201,212,135,154,226,155,92,171,94,106,191,198,136,126,203,80,69,155,160,87,163]},p={name:"Macintosh II (1987)",type:n.Indexed,group:o.RetroPC,data:[255,255,255,255,255,0,255,102,0,221,0,0,255,0,153,51,0,153,0,0,204,0,153,255,0,170,0,0,102,0,102,51,0,153,102,51,187,187,187,136,136,136,68,68,68,0,0,0]},g={name:"Windows 4-bit RGBI",type:n.Indexed,group:o.RetroPC,data:[0,0,0,0,0,128,0,128,0,0,128,128,128,0,0,128,0,128,128,128,0,192,192,192,128,128,128,0,0,255,0,255,0,0,255,255,255,0,0,255,0,255,255,255,0,255,255,255]},m={name:"Windows 20-color Extended RGBI",type:n.Indexed,group:o.RetroPC,data:[0,0,0,0,0,128,0,128,0,0,128,128,128,0,0,128,0,128,128,128,0,192,192,192,192,220,192,166,202,240,255,251,240,160,160,164,128,128,128,0,0,255,0,255,0,0,255,255,255,0,0,255,0,255,255,255,0,255,255,255]},f={name:"ZX Spectrum 4-bit RGBI",type:n.Indexed,group:o.RetroPC,data:[0,0,0,0,0,215,0,215,0,0,215,215,215,0,0,215,0,215,215,215,0,215,215,215,0,0,255,0,255,0,0,255,255,255,0,0,255,0,255,255,255,0,255,255,255]},y={name:"Game Boy (2-bit MC)",type:n.Indexed,group:o.RetroVC,data:[15,56,15,48,98,48,139,172,15,155,188,15]},x={name:"8-color RGB (3-bit, 1bpc)",type:n.RGB,group:o.RGB,data:[2,2,2]},C={name:"16-color RGB (4-bit, 1-2-1)",type:n.RGB,group:o.RGB,data:[2,4,2]},w={name:"64-color RGB (6-bit, 2bpc)",type:n.RGB,group:o.RGB,data:[4,4,4]},v={name:"256-color RGB (8-bit, 3-3-2)",type:n.RGB,group:o.RGB,data:[8,8,4]},M={name:"Black/White (1-bit MC)",type:n.Mono,group:o.Mono,data:[2,0,255,255,255]},b={name:"Black/Green (1-bit MC)",type:n.Mono,group:o.Mono,data:[2,0,0,255,0]},E={name:"Black/Amber (1-bit MC)",type:n.Mono,group:o.Mono,data:[2,0,255,200,15]},I={name:"4-tone Greyscale (2-bit MC)",type:n.Mono,group:o.Mono,data:[4,0,255,255,255]},A={name:"4-tone Amber (2-bit MC)",type:n.Mono,group:o.Mono,data:[4,.04,255,200,15]},B={name:"16-tone Greyscale (4-bit MC)",type:n.Mono,group:o.Mono,data:[16,0,255,255,255]},G={name:"Pip-Boy 3000 (2-bit MC)",type:n.Mono,group:o.Mono,data:[4,.15,64,252,155]},R={name:"Green/Magenta (2-bit, 1bpc)",type:n.Mixer,group:o.Duo,data:[2,0,0,0,2,0,0,255,0,2,0,255,0,255]},P={name:"Red/Cyan (4-bit, 2bpc)",type:n.Mixer,group:o.Duo,data:[2,0,0,0,4,0,255,0,0,4,0,0,255,255]},k={name:"Green/Magenta (4-bit, 2bpc)",type:n.Mixer,group:o.Duo,data:[2,0,0,0,4,0,0,255,0,4,0,255,0,255]},T={name:"Blue/Yellow (4-bit, 2bpc)",type:n.Mixer,group:o.Duo,data:[2,0,0,0,4,0,0,0,255,4,0,255,255,0]},L={name:"White/Amber (4-bit, 2bpc)",type:n.Mixer,group:o.Duo,data:[2,0,0,0,4,0,255,255,255,4,0,255,200,15]},S={name:"Orange/Dark Green (4-bit, 2bpc)",type:n.Mixer,group:o.Duo,data:[2,0,0,0,4,0,240,110,50,4,0,20,75,65]},$={name:"Orange/Blue (4-bit, 2bpc)",type:n.Mixer,group:o.Duo,data:[2,0,0,0,4,0,240,110,50,4,0,15,45,135]},D={name:"CMYK (Unmixed, 1 level)",type:n.Indexed,group:o.CMYK,data:[255,255,255,0,174,239,236,0,140,255,242,0,16,16,16]},z={name:"CMYK (Unmixed, 2 levels)",type:n.Indexed,group:o.CMYK,data:[255,255,255,128,214,247,0,174,239,246,128,198,236,0,140,255,249,128,255,242,0,136,136,136,16,16,16]},N={name:"CMYK (Unmixed, 4 levels)",type:n.Indexed,group:o.CMYK,data:[255,255,255,192,235,251,128,214,247,64,194,243,0,174,239,251,192,227,246,128,198,241,64,169,236,0,140,255,252,192,255,249,128,255,245,64,255,242,0,196,196,196,136,136,136,76,76,76,16,16,16]},O={name:"16-color CMYK (4-bit, 1bpc)",type:n.Mixer,group:o.CMYK,data:[4,1,0,0,2,0,0,174,239,2,0,236,0,140,2,0,255,242,0,2,0,16,16,16]},Y={name:"64-color CMYK (6-bit, 1-1-1-3)",type:n.Mixer,group:o.CMYK,data:[4,1,0,0,2,0,0,174,239,2,0,236,0,140,2,0,255,242,0,4,0,16,16,16]},K={name:"256-color CMYK (8-bit, 2bpc)",type:n.Mixer,group:o.CMYK,data:[4,1,0,0,4,0,0,174,239,4,0,236,0,140,4,0,255,242,0,4,0,16,16,16]},F={name:"Auto 16-color (4-bit indexed)",type:n.Auto,group:o.Auto,data:[16,-1,5,1]},U={name:"Auto 64-color (6-bit indexed)",type:n.Auto,group:o.Auto,data:[64,1,5,1]},H={name:"Auto 256-color (8-bit indexed)",type:n.Auto,group:o.Auto,data:[256,2,5,1]};function V(e,t,o){let r=[],n=Number.POSITIVE_INFINITY;for(let a=0;a<t.length;a++){const s=o(e,t[a]);s<=n&&(r=t[a],n=s)}return r}const W=class{static getSize(e){switch(e.type){case n.Indexed:return e.data.length/3;case n.Mono:return e.data[0];case n.RGB:return e.data[0]*e.data[1]*e.data[2];case n.Mixer:{const t=(e.data.length-4)/5;let o=1;for(let r=0;r<t;r++)o*=e.data[4+5*r];return o}case n.Auto:return e.data[0];default:return 0}}static getColor(e,t){if(t<0||t>=this.getSize(e))throw new Error(`Color index ${t} out of bounds`);switch(e.type){case n.Indexed:return e.data.slice(3*t,3*t+3);case n.Mono:return e.data.slice(2,5).map((o=>{const r=o*e.data[1];return r+t*~~((o-r)/(e.data[0]-1))}));case n.Mixer:return this.getMixerColor(e,t);case n.RGB:{const o=t%e.data[2],r=~~(t/e.data[2])%e.data[1];return[~~(t/(e.data[2]*e.data[1])),r,o].map(((t,o)=>t*~~(255/(e.data[o]-1))))}case n.Auto:default:throw new Error("Invalid or Auto palette type")}}static getColors(e){return Array.from({length:this.getSize(e)},((t,o)=>this.getColor(e,o)))}static transform(e,t){const r=this.getColors(e).map((e=>t(e)));return{name:`${e.name} :: ${t.name}`,type:n.Indexed,group:o.Generated,data:r.reduce(((e,t)=>e.concat(t)))}}static getMixerColor(e,t){const o=1===e.data.slice(0,4)[1],r=(e.data.length-4)/5,n=o?[255,255,255]:[0,0,0],a=t=>e.data[4+5*t],s=t=>e.data[5+5*t],i=t=>e.data.slice(6+5*t,9+5*t),l=e=>{let o=t;for(let t=0;t<e;t++)o=~~(o/a(t));return o%a(e)};for(let e=0;e<r;e++)i(e).forEach(((t,r)=>{o&&(t=255-t);const i=t*s(e),d=t-i,c=i+l(e)*~~(d/(a(e)-1));n[r]+=o?-c:c,n[r]<0&&(n[r]=0)}));return n}},j={id:"ProcBasic",name:"Basic (no dithering)",procFn:(e,t,o,r,n)=>{const a=4*e.width,s=e.width*e.height*4,i=W.getColors(t);for(let t=0;t<s;t+=4){const r=V(Array.from(e.data.slice(t,t+4)),i,o);for(let o=0;o<3;o++)e.data[t+o]=r[o];t%(8*a)==0&&n&&n(t,s,e)}return e},maxAllowedPaletteSize:65536,supports:{threads:!1,gamma:!1},complexity:e=>e};function _(e,t=2.2){return e.map((e=>{let o=e/255;return o=o>.04045?Math.pow((o+.055)/1.055,t):o/12.92,100*o}))}function X(e,t=2.2){return e.map((e=>{let o=e/100;return o=o>.0031308?1.055*Math.pow(o,1/t)-.055:12.92*o,~~(255*o)}))}function J(e,t){return r=t,((o=e)[0]-r[0])*(o[0]-r[0])+(o[1]-r[1])*(o[1]-r[1])+(o[2]-r[2])*(o[2]-r[2]);var o,r}function Q(e,t){return J(X(e),X(t))}function Z(e){return(t,o,r,n,a)=>{const s=t.width*t.height*4,i=4*t.width,l=W.getColors(o);if(n.gamma){for(let e=0;e<s;e+=4){const o=_(Array.from(t.data.slice(e,e+3)));for(let r=0;r<3;r++)t.data[e+r]=o[r];e%(4*i)==0&&a&&a(e,s,t)}for(let e=0;e<l.length;e++)l[e]=_(l[e])}for(let o=0;o<s;o+=4){const r=Array.from(t.data.slice(o,o+3)),d=V(r,l,n.gamma?Q:J),c=o%i/4;for(let e=0;e<3;e++)t.data[o+e]=(n.gamma?X(d):d)[e];const h=r.map(((e,t)=>e-d[t]));for(let r=0;r<e.length;r++){const n=o+4*e[r].x+e[r].y*i;if(c+e[r].x>=0&&c+e[r].x<t.width)for(let o=0;o<3;o++)t.data[n+o]+=h[o]*e[r].w}o%(4*i)==0&&a&&a(o,s,t)}return t}}const q={id:"ProcFloydSteinberg",name:"Floyd–Steinberg",procFn:Z([{x:1,y:0,w:7/16},{x:-1,y:1,w:3/16},{x:0,y:1,w:5/16},{x:1,y:1,w:1/16}]),maxAllowedPaletteSize:65536,supports:{threads:!1,gamma:!0},complexity:e=>2*e},ee=Array.from({length:100001});function te(e){const t=[0,0,0];for(let o=0;o<3;o++)t[o]=Math.pow(e[o]/255,2.2);return t}function oe(e){const t=[0,0,0];for(let o=0;o<3;o++)0===e[o]?t[o]=0:e[o]<0?t[o]=-1*ee[~~(1e5*-e[o])]:t[o]=ee[~~(1e5*e[o])];return t}const re=[0,48,12,60,3,51,15,63,32,16,44,28,35,19,47,31,8,56,4,52,11,59,7,55,40,24,36,20,43,27,39,23,2,50,14,62,1,49,13,61,34,18,46,30,33,17,45,29,10,58,6,54,9,57,5,53,42,26,38,22,41,25,37,21].map((e=>e/64));function ne(e,t,o,r,n){return n(e,t)+o*((r<0?-r:r)+.5)}function ae(e=!0){return(t,o,r,n,a)=>{const s=t.width*t.height*4,i=4*t.width,l=W.getColors(o),d={};for(let e=0;e<l.length;e++)for(let t=e;t<l.length;t++)d[e*l.length+t]=.1*r(l[e],l[t]);const c=n.gamma?W.getColors(W.transform(o,te)):[],h=[0,0,0];let u,p,g,m,f=[],y=[];for(let o=0;o<s;o+=4){u=Array.from(t.data.slice(o,o+3));const x=re[o%i/4%8+~~(o/i)%8*8];m={color1:[0,0,0],color2:u,ratio:.33};let C=Number.MAX_VALUE;for(let t=0;t<l.length;t++)for(let o=t;o<l.length;o++)if(p=l[t],g=l[o],n.gamma&&(f=c[t],y=c[o]),e){let e=32;t!==o&&(e=((p[0]!==g[0]?19136*(u[0]-p[0])/(g[0]-p[0]):0)+(p[1]!==g[1]?37568*(u[1]-p[1])/(g[1]-p[1]):0)+(p[2]!==g[2]?7296*(u[2]-p[2])/(g[2]-p[2]):0))/((p[0]!==g[0]?299:0)+(p[1]!==g[1]?587:0)+(p[2]!==g[2]?114:0)),e<0?e=0:e>63&&(e=63),e=~~e);const a=e/64;if(n.gamma)for(let e=0;e<3;e++)h[e]=f[e]+a*(y[e]-f[e]);else for(let e=0;e<3;e++)h[e]=p[e]+a*(g[e]-p[e]);const s=d[t*l.length+o],i=ne(u,n.gamma?oe(h):h,s,a-.5,r);i<C&&(C=i,m.color1=p,m.color2=g,m.ratio=a)}else for(let e=0;e<64&&!(t===o&&e>0);e++){const a=e/64;if(n.gamma)for(let e=0;e<3;e++)h[e]=f[e]+a*(y[e]-f[e]);else for(let e=0;e<3;e++)h[e]=p[e]+a*(g[e]-p[e]);const s=d[t*l.length+o],i=ne(u,n.gamma?oe(h):h,s,a-.5,r);i<C&&(C=i,m.color1=p,m.color2=g,m.ratio=a)}for(let e=0;e<3;e++)t.data[o+e]=x<m.ratio?m.color2[e]:m.color1[e];o%(4*i)==0&&a&&a(o,s,t)}return t}}const se={id:"ProcBayerLikeFast",name:"Bayer-like – Fast",procFn:ae(),maxAllowedPaletteSize:192,supports:{threads:!0,gamma:!1},complexity:e=>e*e/2},ie={id:"ProcBayerLikeThorough",name:"Bayer-like – High Quality",procFn:ae(!1),maxAllowedPaletteSize:24,supports:{threads:!0,gamma:!1},complexity:e=>e*e*32},le=[0,48,12,60,3,51,15,63,32,16,44,28,35,19,47,31,8,56,4,52,11,59,7,55,40,24,36,20,43,27,39,23,2,50,14,62,1,49,13,61,34,18,46,30,33,17,45,29,10,58,6,54,9,57,5,53,42,26,38,22,41,25,37,21].map((e=>e/64)),de={id:"ProcColorThresholdMatrix",name:"Color Threshold Matrix",procFn:(e,t,o,r,n)=>{const a=e.width*e.height*4,s=4*e.width,i=[];let l,d,c,h;const u=[0,0,0],p=W.getColors(t).map((e=>299*e[0]+587*e[1]+114*e[2])),g=W.getColors(t),m=W.getColors(r.gamma?W.transform(t,te):t);for(let t=0;t<a;t+=4){l=Array.from(e.data.slice(t,t+4));const y=t%s/4,x=~~(t/s);for(i.splice(0),c=[0,0,0];i.length<16;){let e=0,t=1,n=Number.MAX_VALUE;const a=i.length||1;for(let s=0;s<m.length;s++){d=[...m[s]],h=[...c];for(let p=1;p<=a;p*=2){const a=i.length+p;for(let e=0;e<3;e++)h[e]=c[e]+d[e]*p,u[e]=h[e]/a,r.gamma&&(u[e]=0===(f=u[e])?0:f<0?-1*ee[~~(1e5*-f)]:ee[~~(1e5*f)]);const g=o(u,l);g<n&&(t=p,e=s,n=g)}}for(let o=0;o<t;o++)i.push(e);for(let o=0;o<3;o++)c[o]+=m[e][o]*t}i.sort(((e,t)=>p[e]-p[t]));const C=~~(le[y%8+x%8*8]*i.length);for(let o=0;o<3;o++)e.data[t+o]=g[i[C]][o];t%(4*s)==0&&n&&n(t,a,e)}var f;return e},maxAllowedPaletteSize:64,supports:{threads:!0,gamma:!0},complexity:e=>384*e};function ce(){return new Worker(t.p+"main.worker.js")}var he;!function(e){e[e.Progress=0]="Progress",e[e.Done=1]="Done",e[e.Error=2]="Error"}(he||(he={}));const ue=class{constructor(){this.busy=!1,this.x=0,this.y=0,this.worker=new ce,this.worker.onmessage=e=>{const t=e.data;switch(t.msg){case he.Progress:this.onprogress&&this.onprogress(Object.assign(Object.assign({},t.params),{partial:t.params.partial?{data:t.params.partial,x:this.x,y:this.y}:void 0}));break;case he.Done:this.onfinish&&this.onfinish({data:t.params.result,x:this.x,y:this.y}),this.busy=!1;break;case he.Error:this.onerror&&this.onerror(t.params.error),this.busy=!1}}}get ready(){return!this.busy}start(e,t,o,r,n){return!this.busy&&(this.busy=!0,this.worker.postMessage({dataIn:e.data,palette:t,procId:o,distFnId:r,features:n}),!0)}terminate(){this.worker.terminate()}};class pe{constructor(e){var t;this.generated=!1,this.levels=e.levels,this.tree=(t=e.levels,Array.from({length:Math.pow(8,t)},(()=>new class{constructor(){this.colors=[],this.pixels=0}get pixelCount(){return this.pixels}get avgColor(){const e=[0,0,0];for(let t=0;t<this.colors.length;t++)for(let o=0;o<3;o++)e[o]+=this.colors[t][o];return e.map((e=>e/this.colors.length))}addColor(e){this.colors.includes(e)||this.colors.push(e),this.pixels++}}))),this.ctes=[],this.reservedLevel=e.reservedLevel,this.nColors=e.size,this.k=e.thresholdCoeff||1}addColor(e){if(this.generated)throw new Error("Attempting to modify a generated palette");const t=this.index(e);return this.tree[t].addColor(e),t}getPalette(){this.generated||this.generate();const e=[];return this.ctes.forEach((t=>{const o=t.index,r=[0,0,0];for(let e=0;e<t.level;e++)for(let n=2;n>=0;n--){const a=3*(t.level-1-e)+n,s=1<<3*t.level-1>>3*e+(2-n);r[2-n]=r[2-n]<<1|(o&s)>>a}for(let e=t.level;e<8;e++)for(let o=0;o<3;o++)r[o]=r[o]<<1|(e===t.level?1:0);e.push(r)})),console.log(`Built palette with ${e.length} colors`),e}index(e){let t=0;for(let o=0;o<this.levels;o++){const r=7-o;let n=0;for(let t=0;t<3;t++){const a=128>>o;n=n<<1|(e[t]&a)>>r}t=t<<3|n}return t}getNode(e,t){if(t===this.levels)return this.tree[e];const o=[];for(let r=0;r<8;r++)this.isCTE(8*e+r,t+1)||o.push(this.getNode(8*e+r,t+1));return o.filter((e=>e.pixelCount>0)).reduce(((e,t)=>({pixelCount:e.pixelCount+t.pixelCount})),{pixelCount:0})}isCTE(e,t){return this.ctes.some((o=>o.index===e&&o.level===t))}markCTE(e,t,o){this.ctes.push({index:e,level:t,node:o})}testNode(e,t,o,r){const n=e-t-this.ctes.length,a=(o-this.ctes.map((e=>e.node.pixelCount)).reduce(((e,t)=>e+t),0))/n*this.k;return r.pixelCount>a}get nonReservedCTEs(){return this.ctes.filter((e=>e.level!==this.reservedLevel)).length}generate(){if(this.generated)throw new Error("This palette has already been generated");this.generated=!0;const e=this.reservedLevel<0?0:Math.pow(8,this.reservedLevel),t=this.getNode(0,0).pixelCount;let o,r=0,n=0;for(;this.nColors-e-this.nonReservedCTEs>0;){for(o=this.levels;o>this.reservedLevel&&o>0;){const r=Math.pow(8,o);for(let n=0;n<r;n++){const r=this.getNode(n,o);if(!this.isCTE(n,o)&&this.testNode(this.nColors,e,t,r)&&this.markCTE(n,o,r),n%8==7){let e=0;for(let t=n-7;t<=n;t++)this.isCTE(t,o)&&e++;if(e>0&&e<8){const e=n>>3;this.isCTE(e,o-1)||this.markCTE(e,o-1,this.getNode(e,o-1))}}if(this.nColors-e-this.nonReservedCTEs<=0)break}if(this.nColors-e-this.nonReservedCTEs<=0)break;o--}if(this.ctes.length===r&&(this.k=this.k/2,n++,n>=5))break;r=this.ctes.length}if(this.reservedLevel>=0){o=this.reservedLevel;const e=Math.pow(8,o);for(let t=0;t<e;t++){const e=this.getNode(t,o);this.isCTE(t,o)||this.markCTE(t,o,e)}}}}const ge=[];const me=navigator.hardwareConcurrency,fe=Math.max(~~(me/2),1),ye=[];function xe(e,t,r,a,s,i){return new Promise(((l,d)=>{t.width=e.width,t.height=e.height;const c=e.getContext("2d");if(!c)throw new Error("Unable to get input context");const h=t.getContext("2d");if(!h)throw new Error("Unable to get output context");let u=(new Date).getTime();const p=c.getImageData(0,0,e.width,e.height);let g;if(r=function(e,t,r){return e.type===n.Auto?function(e,t){const r=`AUTO_${e.size}L${e.levels}R${e.reservedLevel}`,a=ge.find((e=>e.key===r));if(a)return a.palette;{const a=function(e,t){const r=new pe(e),a=t.width*t.height*4;for(let e=0;e<a;e+=4){const o=~~(e/4/t.width);if(~~(e/4%t.width)%2==0&&o%2==0){const o=Array.from(t.data.slice(e,e+4));r.addColor(o)}}const s=r.getPalette();return{name:`AUTO_${e.size}L${e.levels}R${e.reservedLevel}`,type:n.Indexed,group:o.Generated,data:s.reduce(((e,t)=>e.concat(t)))}}(e,t);return ge.push({key:r,palette:a}),a}}({size:e.data[0],reservedLevel:e.data[1],levels:e.data[2],thresholdCoeff:e.data[3]},r):e}(r,0,p),console.log(`Palette processing done in ${(new Date).getTime()-u}ms`),a.supports.threads)if("auto"===i.threads){const t=((e,t)=>e.complexity(W.getSize(t)))(a,r),o=e.width*e.height,n=1+~~(o/5e4*t/2048);g=n>fe?fe:n,console.log(`Want ${n} threads for ${o}px @CR${t}, got ${g} (max ${fe})`)}else g=i.threads;else g=1;let m=0;const f=8*~~(e.width/g/8),y=e.width-f*g;u=(new Date).getTime();for(let t=0;t<g;t++){const o=~~(y/8),n=t*f+8*(o<t?o:t),p=f+(t===g-1?y%8:o>t?8:0),x=c.getImageData(n,0,p,e.height);x||d("Unable to get image data from context");const C={data:x,x:n,y:0},w=new ue;w.onprogress=e=>{e.partial&&h.putImageData(e.partial.data,n,0),h.fillStyle="#ff00ff",h.fillRect(n,e.current/(4*p),p,2)},w.onfinish=e=>{h.putImageData(e.data,n,0),m--,ye.splice(ye.indexOf(w),1);const o=(new Date).getTime();console.log(`Worker thread ${t+1} done in ${o-u}ms`),0===m&&(console.log(`${g} worker threads done in ${o-u}ms`),l())},w.onerror=e=>d(`Error in worker thread: ${e}`),console.log(`Starting worker thread ${t+1}/${g} w=${p}`),w.start(C,r,a.id,s,i),m++,ye.push(w)}}))}const Ce={id:"ProcMinAverageError",name:"Minimum Average Error (JJ&N)",procFn:Z([{x:1,y:0,w:7/48},{x:2,y:0,w:5/48},{x:-2,y:1,w:3/48},{x:-1,y:1,w:5/48},{x:0,y:1,w:7/48},{x:1,y:1,w:5/48},{x:2,y:1,w:3/48},{x:-2,y:2,w:1/48},{x:-1,y:2,w:3/48},{x:0,y:2,w:5/48},{x:1,y:2,w:3/48},{x:2,y:2,w:1/48}]),maxAllowedPaletteSize:65536,supports:{threads:!1,gamma:!0},complexity:e=>6*e},we={name:"Apple II (16-color) (*)",type:n.Indexed,group:o.RetroPC,data:[0,0,0,156,156,156,255,255,255,96,78,189,208,195,255,255,68,253,227,30,96,255,160,208,255,106,60,96,114,3,208,221,141,20,245,60,0,163,96,114,255,208,20,207,253]},ve={name:"Apple II High-res (6-color) (*)",type:n.Indexed,group:o.RetroPC,data:[0,0,0,255,255,255,255,68,253,255,106,60,20,245,60,20,207,253]},Me={name:"Apple IIGS (Master Color Values)",type:n.Indexed,group:o.RetroPC,data:[0,0,0,221,0,51,0,0,153,221,34,221,0,119,34,85,85,85,34,34,255,102,170,255,136,85,0,255,102,0,170,170,170,255,153,136,17,221,0,255,255,0,68,255,153,255,255,255]},be={name:"NES (All colors) (*)",type:n.Indexed,group:o.RetroVC,data:[0,0,0,40,40,40,168,168,168,0,24,32,0,96,112,0,192,208,144,224,232,0,30,0,0,104,16,0,200,112,144,232,200,0,104,0,40,192,32,168,232,160,0,24,0,8,88,0,112,176,0,200,224,144,16,0,0,96,64,0,192,152,0,232,216,136,64,0,0,160,32,0,248,128,24,248,200,160,88,0,0,208,16,0,248,112,104,248,192,192,88,0,16,208,0,88,248,112,176,248,192,224,56,0,80,160,8,168,248,104,248,248,192,248,0,8,112,88,24,216,152,104,248,208,184,248,0,8,120,8,48,224,80,120,248,176,192,248,0,8,88,0,72,184,32,160,248,168,216,248,72,72,72,160,160,160,248,248,248]};!function(e){for(let e=0;e<=1e5;e++)ee[e]=255*Math.pow(e/1e5,1/2.2)}();const Ee=document.getElementById("canvasOriginal"),Ie=document.getElementById("canvasOutput"),Ae=document.getElementById("fileInput"),Be=document.getElementById("resizeInput"),Ge=document.getElementById("paletteSelect"),Re=document.getElementById("processSelect"),Pe=document.getElementById("advancedOptions"),ke=document.getElementById("featGamma"),Te=document.getElementById("allowSlow"),Le=document.getElementById("featThreads"),Se=document.getElementById("threadModeAuto"),$e=document.getElementById("threadModeManual"),De=document.getElementById("threadCount"),ze=document.getElementById("toggleAdvanced"),Ne=document.getElementById("toggleOriginal"),Oe=document.getElementById("startStop"),Ye=document.getElementById("slowWarning"),Ke=document.getElementById("flash"),Fe=Ee.getContext("2d"),Ue=Ie.getContext("2d");Te.addEventListener("change",(function(){Te.checked?Ye.style.removeProperty("display"):Ye.style.setProperty("display","none"),Je(),Qe()}));const He=[a,s,i,l,d,c,we,ve,Me,u,h,p,g,m,f,y,be,M,b,E,I,A,B,G,R,P,k,T,L,S,$,x,C,w,v,D,z,N,O,Y,K,F,U,H];let Ve=g;He.forEach((e=>{const t=document.createElement("option");let o;t.setAttribute("value",e.name),t.text=e.name;const r=Ge.getElementsByTagName("optgroup");for(let t=0;t<r.length;t++)r[t].label===e.group&&(o=r[t]);o||(o=document.createElement("optgroup"),o.label=e.group,Ge.appendChild(o)),o.appendChild(t)})),Ge.value=Ve.name;const We=[j,q,Ce,se,ie,de];let je=j;function _e(){Se.disabled=!Le.checked,$e.disabled=!Le.checked,De.disabled=!Le.checked||!$e.checked}We.forEach((e=>{const t=document.createElement("option");t.setAttribute("value",e.name),t.text=e.name,Re.appendChild(t)})),Ge.addEventListener("change",(function(e){Ve=He.find((t=>t.name===e.target.value))||Ve,Je()})),Re.addEventListener("change",(function(e){je=We.find((t=>t.name===e.target.value))||je,Qe()})),Ae.addEventListener("change",(function(e){var t;(t=e,new Promise(((e,o)=>{const r=t.target;if(null==r?void 0:r.files){const t=r.files[0],o=new Image;o.onload=()=>e(o),o.src=URL.createObjectURL(t)}else o()}))).then((e=>function(e){let t=e.width,o=e.height;const r=parseInt(Be.value,10);t>=o&&t>r&&(o=r*(o/t),t=r),o>t&&o>r&&(t=r*(t/o),o=r),Ee.width=t,Ee.height=o,null==Fe||Fe.drawImage(e,0,0,t,o),Ie.width=t,Ie.height=o,null==Ue||Ue.clearRect(0,0,t,o),ge.splice(0)}(e)))})),Ne.addEventListener("click",(function(){Ie.classList.contains("clip")?Ie.classList.remove("clip"):Ie.classList.add("clip")})),ze.addEventListener("click",(function(){const e="none"!==getComputedStyle(Pe).getPropertyValue("display");e?Pe.style.setProperty("display","none"):Pe.style.removeProperty("display"),ze.innerHTML=(e?"Show":"Hide")+" advanced options"})),De.value="2",De.min="1",De.max=me.toString(),Le.addEventListener("change",_e),Se.addEventListener("change",_e),$e.addEventListener("change",_e),De.addEventListener("change",_e);let Xe=!1;function Je(){const e=Re.children;for(let t=0;t<e.length;t++){const o=e[t],r=We.find((e=>e.name===o.value));r&&(o.disabled=!Te.checked&&r.maxAllowedPaletteSize<W.getSize(Ve))}}function Qe(){const e=Ge.getElementsByTagName("option");for(let t=0;t<e.length;t++){const o=e[t],r=He.find((e=>e.name===o.value));r&&(o.disabled=!Te.checked&&je.maxAllowedPaletteSize<W.getSize(r))}}Oe.addEventListener("click",(()=>{Xe?(ye.forEach((e=>e.terminate())),ye.splice(0),Oe.innerHTML="Start",Xe=!1):function(){Ke.classList.remove("flash-anim");const e=Le.checked?Se.checked?"auto":parseInt(De.value,10):1;Xe=!0,Oe.innerHTML="Stop",xe(Ee,Ie,Ve,je,"cdRGB",{gamma:ke.checked,threads:e}).then((()=>{Ke.classList.add("flash-anim"),Oe.innerHTML="Start",Xe=!1}))}()}))})();